<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixly - Costeo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2a2a2a;
        }

        .nav-title {
            font-size: 1.5em;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-btn {
            color: #888;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        .nav-btn:hover {
            color: #fff;
            border-color: #dc2626;
        }

        .header {
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        @media (max-width: 1000px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 40px;
        }

        .card h2 {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }

        .recipe-name {
            width: 100%;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 30px;
            transition: border-color 0.3s;
        }

        .recipe-name:focus {
            outline: none;
            border-color: #dc2626;
        }

        .recipe-name::placeholder {
            color: #444;
        }

        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        select, input[type="number"] {
            padding: 12px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            color: #fff;
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: #dc2626;
        }

        option {
            background: #0a0a0a;
            color: #fff;
        }

        .remove-btn {
            background: transparent;
            color: #666;
            border: 1px solid #2a2a2a;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
        }

        .add-ingredient-btn {
            width: 100%;
            background: transparent;
            color: #888;
            border: 1px solid #2a2a2a;
            padding: 12px;
            cursor: pointer;
            font-size: 0.9em;
            letter-spacing: 1px;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .add-ingredient-btn:hover {
            color: #fff;
            border-color: #444;
        }

        .calculate-btn {
            width: 100%;
            background: #dc2626;
            color: #fff;
            border: none;
            padding: 18px;
            cursor: pointer;
            font-size: 1em;
            letter-spacing: 1px;
            margin-top: 30px;
            transition: background 0.3s;
        }

        .calculate-btn:hover {
            background: #b91c1c;
        }

        .result-box {
            background: #0a0a0a;
            border: 2px solid #dc2626;
            padding: 40px;
            text-align: center;
            margin-top: 30px;
        }

        .result-label {
            color: #666;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .result-value {
            font-size: 3.5em;
            font-weight: 300;
            color: #dc2626;
        }

        .breakdown {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            padding: 30px;
            margin-top: 20px;
        }

        .breakdown h3 {
            font-size: 1em;
            font-weight: 400;
            margin-bottom: 20px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item small {
            color: #666;
            font-size: 0.85em;
        }

        .breakdown-cost {
            font-weight: 400;
            color: #dc2626;
        }

        .save-recipe-btn {
            width: 100%;
            background: transparent;
            color: #888;
            border: 1px solid #2a2a2a;
            padding: 18px;
            cursor: pointer;
            font-size: 1em;
            letter-spacing: 1px;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .save-recipe-btn:hover {
            color: #fff;
            border-color: #444;
        }

        .recipe-card {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            padding: 25px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .recipe-card:hover {
            border-color: #444;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1a1a1a;
        }

        .recipe-title {
            font-size: 1.3em;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .recipe-cost {
            font-size: 1.8em;
            color: #dc2626;
            font-weight: 300;
        }

        .delete-recipe-btn {
            background: transparent;
            color: #666;
            border: 1px solid #2a2a2a;
            padding: 8px 16px;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.3s;
        }

        .delete-recipe-btn:hover {
            color: #dc2626;
            border-color: #dc2626;
        }

        .recipe-date {
            color: #444;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .ingredient-line {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9em;
            color: #888;
        }

        .ingredient-cost {
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #444;
        }

        .warning {
            background: #1a1a1a;
            border-left: 3px solid #dc2626;
            color: #fff;
            padding: 20px;
            margin-bottom: 30px;
        }

        .warning a {
            color: #dc2626;
            text-decoration: none;
            border-bottom: 1px solid #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <div class="nav-title">COSTEO</div>
            <div class="nav-links">
                <a href="index.html" class="nav-btn">INICIO</a>
                <a href="productos.html" class="nav-btn">PRODUCTOS</a>
            </div>
        </div>

        <div id="warningBox" class="warning" style="display: none;">
            ⚠ No hay productos cargados. <a href="productos.html">Agrega productos primero</a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>Calculadora de Costeo</h1>
            <p class="subtitle">Calcula el costo exacto de tus cócteles</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left: Calculator -->
            <div class="card">
                <h2>Nueva Receta</h2>
                
                <input type="text" id="recipeName" class="recipe-name" placeholder="Nombre del cóctel">

                <div id="ingredientsContainer"></div>

                <button class="add-ingredient-btn" onclick="addIngredient()">+ AGREGAR INGREDIENTE</button>
                
                <button class="calculate-btn" onclick="calculateCost()">CALCULAR COSTO</button>

                <div id="resultBox" style="display: none;">
                    <div class="result-box">
                        <div class="result-label">Costo Total</div>
                        <div class="result-value" id="totalCost">$0.00</div>
                    </div>

                    <div class="breakdown">
                        <h3>Desglose</h3>
                        <div id="breakdownList"></div>
                    </div>

                    <button class="save-recipe-btn" onclick="saveRecipe()">GUARDAR RECETA</button>
                </div>
            </div>

            <!-- Right: Saved Recipes -->
            <div class="card">
                <h2>Recetas Guardadas</h2>
                <div id="savedRecipes">
                    <div class="empty-state">
                        No hay recetas guardadas
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const SUPABASE_URL = "https://hhfpaviwuuqcuhcsfwdj.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZnBhdml3dXVxY3VoY3Nmd2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzgwMDgsImV4cCI6MjA3ODg1NDAwOH0.LpccdL9cQqf4vZ5BPqRKnL2Mh5GiLd57pQKujcDHDLg";
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        let products = [];
        let ingredients = [];
        let currentRecipe = null;
        let savedRecipes = [];

        window.onload = async function () {
            await loadProductsFromSupabase();
            loadRecipes();
            addIngredient();
        };

        async function loadProductsFromSupabase() {
            try {
                const { data, error } = await db
                    .from("products")
                    .select("*")
                    .order("name", { ascending: true });

                if (error) {
                    console.error("Error cargando productos:", error);
                    alert("Error cargando productos desde Supabase");
                    return;
                }

                products = data || [];

                if (products.length === 0) {
                    document.getElementById("warningBox").style.display = "block";
                }
            } catch (err) {
                console.error(err);
            }
        }

        function loadRecipes() {
            const saved = localStorage.getItem("bar-recipes");
            if (saved) {
                savedRecipes = JSON.parse(saved);
                renderSavedRecipes();
            }
        }

        window.addIngredient = function() {
            const container = document.getElementById("ingredientsContainer");
            const id = Date.now();

            const row = document.createElement("div");
            row.className = "ingredient-row";
            row.id = "ingredient-" + id;

            row.innerHTML = `
                <select id="product-${id}" onchange="updateIngredient(${id})">
                    <option value="">Seleccionar producto</option>
                    ${products
                        .map(
                            (p) =>
                                `<option value="${p.id}">${p.name} (${p.category})</option>`
                        )
                        .join("")}
                </select>
                <input type="number" id="quantity-${id}" placeholder="ml" step="0.1" min="0" onchange="updateIngredient(${id})">
                <button class="remove-btn" onclick="removeIngredient(${id})">✕</button>
            `;

            container.appendChild(row);
            ingredients.push({ id: id, productId: null, quantity: 0 });
        };

        window.updateIngredient = function (id) {
            const productSelect = document.getElementById("product-" + id);
            const quantityInput = document.getElementById("quantity-" + id);
            
            if (!productSelect || !quantityInput) return;

            const productId = parseInt(productSelect.value) || null;
            const quantity = parseFloat(quantityInput.value) || 0;

            const ingredient = ingredients.find((i) => i.id === id);
            if (ingredient) {
                ingredient.productId = productId;
                ingredient.quantity = quantity;
            }
        };

        window.removeIngredient = function (id) {
            const element = document.getElementById("ingredient-" + id);
            if (element) {
                element.remove();
            }
            ingredients = ingredients.filter((i) => i.id !== id);
        };

        window.calculateCost = function () {
            // Validar que haya productos cargados
            if (products.length === 0) {
                alert("No hay productos disponibles. Por favor, carga productos primero.");
                return;
            }

            let total = 0;
            let breakdown = [];
            let hasValidIngredients = false;

            // Verificar si hay al menos un ingrediente con datos completos
            for (let ingredient of ingredients) {
                const productSelect = document.getElementById("product-" + ingredient.id);
                const quantityInput = document.getElementById("quantity-" + ingredient.id);
                
                if (productSelect && quantityInput) {
                    const productId = parseInt(productSelect.value);
                    const quantity = parseFloat(quantityInput.value);
                    
                    if (productId && quantity > 0) {
                        hasValidIngredients = true;
                        break;
                    }
                }
            }

            if (!hasValidIngredients) {
                alert("Agrega al menos un ingrediente con producto y cantidad");
                return;
            }

            // Calcular costos
            for (let ingredient of ingredients) {
                if (ingredient.productId && ingredient.quantity > 0) {
                    const product = products.find((p) => p.id === ingredient.productId);

                    console.log("Producto encontrado:", product);
                    console.log("Tiene price_per_ml?", product?.price_per_ml);

                    if (product) {
                        // Intentar obtener price_per_ml de diferentes formas
                        let pricePerMl = product.price_per_ml || product.pricePerMl;
                        
                        // Si no existe, calcular desde price y quantity
                        if (!pricePerMl && product.price && product.quantity) {
                            pricePerMl = Number(product.price) / Number(product.quantity);
                            console.log("price_per_ml calculado:", pricePerMl);
                        }

                        if (pricePerMl && pricePerMl > 0) {
                            const cost = Number(pricePerMl) * Number(ingredient.quantity);
                            total += cost;

                            breakdown.push({
                                name: product.name,
                                quantity: ingredient.quantity,
                                pricePerMl: Number(pricePerMl),
                                cost: cost,
                            });
                        } else {
                            console.error("Producto sin precio válido:", product);
                        }
                    }
                }
            }

            if (breakdown.length === 0) {
                console.error("No se pudo calcular. Productos:", products);
                console.error("Ingredientes:", ingredients);
                alert("No se pudo calcular el costo. Abre la consola (F12) para ver más detalles.");
                return;
            }

            const totalElement = document.getElementById("totalCost");
            if (totalElement) {
                totalElement.textContent = "$" + total.toFixed(2);
            }

            const breakdownList = document.getElementById("breakdownList");
            if (breakdownList) {
                breakdownList.innerHTML = breakdown
                    .map(
                        (item) => `
                    <div class="breakdown-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.quantity} ml × $${item.pricePerMl.toFixed(4)}/ml</small>
                        </div>
                        <div class="breakdown-cost">
                            $${item.cost.toFixed(2)}
                        </div>
                    </div>
                `
                    )
                    .join("");
            }

            const resultBox = document.getElementById("resultBox");
            if (resultBox) {
                resultBox.style.display = "block";
            }

            currentRecipe = {
                breakdown: breakdown,
                total: total,
            };
        };

        window.saveRecipe = function () {
            const nameInput = document.getElementById("recipeName");
            const name = nameInput ? nameInput.value : "";

            if (!name) {
                alert("Escribe un nombre para la receta");
                return;
            }

            if (!currentRecipe) {
                alert("Primero calcula el costo");
                return;
            }

            const recipe = {
                id: Date.now(),
                name: name,
                ingredients: currentRecipe.breakdown,
                totalCost: currentRecipe.total,
                date: new Date().toLocaleDateString(),
            };

            savedRecipes.push(recipe);
            localStorage.setItem("bar-recipes", JSON.stringify(savedRecipes));

            alert("Receta guardada");

            if (nameInput) nameInput.value = "";
            const container = document.getElementById("ingredientsContainer");
            if (container) container.innerHTML = "";
            ingredients = [];
            window.addIngredient();
            
            const resultBox = document.getElementById("resultBox");
            if (resultBox) resultBox.style.display = "none";
            
            currentRecipe = null;

            renderSavedRecipes();
        };

        function renderSavedRecipes() {
            const container = document.getElementById("savedRecipes");
            if (!container) return;

            if (savedRecipes.length === 0) {
                container.innerHTML =
                    '<div class="empty-state">No hay recetas guardadas</div>';
                return;
            }

            container.innerHTML = savedRecipes
                .map(
                    (recipe) => `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <div>
                            <div class="recipe-title">${recipe.name}</div>
                            <div class="recipe-date">${recipe.date}</div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="recipe-cost">$${recipe.totalCost.toFixed(2)}</div>
                            <button class="delete-recipe-btn" onclick="deleteRecipe(${recipe.id})">✕</button>
                        </div>
                    </div>
                    <div>
                        ${recipe.ingredients
                            .map(
                                (ing) => `
                            <div class="ingredient-line">
                                <span>${ing.name} (${ing.quantity}ml)</span>
                                <span class="ingredient-cost">$${ing.cost.toFixed(2)}</span>
                            </div>
                        `
                            )
                            .join("")}
                    </div>
                </div>
            `
                )
                .join("");
        }

        window.deleteRecipe = function (id) {
            if (confirm("¿Eliminar esta receta?")) {
                savedRecipes = savedRecipes.filter((r) => r.id !== id);
                localStorage.setItem("bar-recipes", JSON.stringify(savedRecipes));
                renderSavedRecipes();
            }
        };
    </script>
</body>
</html>