<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
<title>Mixly</title>
<link rel="icon" type="image/png" href="logo.png"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#EDF3FA;--surface:#FFFFFF;--s2:#F4F8FD;
  --border:#C8DDF0;--b2:#DDE9F5;
  --accent:#00C2FF;--a2:#0090CC;--abg:rgba(0,194,255,0.08);
  --text:#0A1628;--t2:#3A5A80;--t3:#7A9EC0;
  --danger:#FF3B5C;--dbg:rgba(255,59,92,0.08);
  --warn:#F59E0B;--wbg:rgba(245,158,11,0.10);
  --ok:#10B981;--obg:rgba(16,185,129,0.08);
  --shadow:0 4px 28px rgba(0,120,200,0.10);
  --shadowL:0 12px 48px rgba(0,120,200,0.16);
  --r:14px;--rs:8px;--sb:72px;
  --dm-transition: background .3s ease, color .3s ease, border-color .3s ease, box-shadow .3s ease;
}

/* ‚ïê‚ïê DARK MODE ‚ïê‚ïê */
.dark{
  --bg:#0D1117;--surface:#161B22;--s2:#1C2333;
  --border:#2D3748;--b2:#243044;
  --accent:#00C2FF;--a2:#38BDF8;--abg:rgba(0,194,255,0.10);
  --text:#E6EDF3;--t2:#8B9DC3;--t3:#4A6080;
  --danger:#FF4D6A;--dbg:rgba(255,77,106,0.10);
  --warn:#FBBF24;--wbg:rgba(251,191,36,0.10);
  --ok:#34D399;--obg:rgba(52,211,153,0.10);
  --shadow:0 4px 28px rgba(0,0,0,0.35);
  --shadowL:0 12px 48px rgba(0,0,0,0.50);
}
.dark body::before{
  background:radial-gradient(ellipse 70% 50% at 92% 4%,rgba(0,194,255,.07) 0%,transparent 60%),
             radial-gradient(ellipse 50% 60% at 4% 92%,rgba(0,100,180,.05) 0%,transparent 60%);
}
.dark .sb{background:rgba(22,27,34,.95);border-right-color:var(--border)}
.dark input,.dark select,.dark textarea{background:var(--s2);border-color:var(--border);color:var(--text)}
.dark input:focus,.dark select:focus,.dark textarea:focus{background:#1C2333;box-shadow:0 0 0 3px rgba(0,194,255,.15)}
.dark select option{background:#1C2333;color:var(--text)}
.dark .bs{background:var(--s2);border-color:var(--border);color:var(--t2)}
.dark .bok{color:#6ee7b7}
.dark .bw{color:#fcd34d}
.dark .aok{color:#6ee7b7}
.dark .aer{color:#fca5a5}
.dark tbody tr:hover td{background:rgba(255,255,255,.03)}
.dark .ni2{background:var(--s2);border-color:var(--border);color:var(--text)}
.dark .loctabs{background:var(--s2)}
.dark .pm{background:rgba(255,255,255,.05);color:var(--t2);border-color:var(--border)}
.dark .hcard:hover{border-color:rgba(0,194,255,.25)}
.dark .cf.show{box-shadow:0 4px 28px rgba(0,0,0,.4)}

/* ‚ïê‚ïê ONBOARDING ‚ïê‚ïê */
#obOverlay{position:fixed;inset:0;z-index:8000;pointer-events:none;display:none}
#obOverlay.active{pointer-events:all;display:block}
.ob-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(2px);
  opacity:0;transition:opacity .35s ease;z-index:8001}
#obOverlay.active .ob-backdrop{opacity:1}
.ob-card{position:fixed;z-index:8002;width:320px;background:var(--surface);
  border-radius:16px;box-shadow:0 24px 64px rgba(0,0,0,.35),0 0 0 1px var(--border);
  opacity:0;transform:translateY(12px) scale(.97);
  transition:opacity .3s ease,transform .3s ease;pointer-events:none}
#obOverlay.active .ob-card{opacity:1;transform:translateY(0) scale(1);pointer-events:all}
.ob-spotlight{position:fixed;z-index:8001;border-radius:12px;
  box-shadow:0 0 0 4px var(--accent),0 0 0 9999px rgba(0,0,0,.65);
  transition:all .45s cubic-bezier(.4,0,.2,1);pointer-events:none;opacity:0}
.ob-header{background:linear-gradient(135deg,var(--accent),var(--a2));
  border-radius:16px 16px 0 0;padding:20px 22px 16px}
.ob-emoji{font-size:2rem;margin-bottom:8px}
.ob-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;
  letter-spacing:1px;text-transform:uppercase;color:#fff;margin-bottom:4px}
.ob-sub{font-size:.75rem;color:rgba(255,255,255,.8);line-height:1.5}
.ob-body{padding:18px 22px 14px}
.ob-desc{font-size:.82rem;color:var(--t2);line-height:1.6;margin-bottom:16px}
.ob-tip{background:var(--abg);border:1px solid rgba(0,194,255,.2);border-radius:8px;
  padding:9px 12px;font-size:.75rem;color:var(--a2);margin-bottom:16px;line-height:1.5}
.ob-tip strong{font-weight:700}
.ob-progress{display:flex;gap:5px;margin-bottom:16px}
.ob-dot{height:4px;border-radius:4px;flex:1;background:var(--b2);transition:.3s}
.ob-dot.done{background:var(--accent)}
.ob-dot.active{background:var(--accent);box-shadow:0 0 6px rgba(0,194,255,.5)}
.ob-footer{display:flex;align-items:center;justify-content:space-between;
  padding:12px 22px 18px}
.ob-skip{font-size:.68rem;color:var(--t3);cursor:pointer;background:none;border:none;
  font-family:'DM Sans',sans-serif;transition:.2s;text-decoration:underline}
.ob-skip:hover{color:var(--t2)}
.ob-nav{display:flex;gap:8px}

/* Help button */
#obHelpBtn{position:fixed;bottom:24px;right:24px;z-index:5000;width:44px;height:44px;
  border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:1.2rem;
  cursor:pointer;box-shadow:0 4px 18px rgba(0,194,255,.45);transition:.2s;
  display:none;align-items:center;justify-content:center;font-weight:700;
  font-family:'Syne',sans-serif}
#obHelpBtn:hover{background:var(--a2);transform:scale(1.08)}

/* Smooth transition on theme switch */
*{transition:var(--dm-transition)}
.panel,.sb,.card,.sc,.hcard,.wbar,.btn,.ni,.ni2,.loctabs,.lt{transition:background .3s,border-color .3s,color .3s,box-shadow .3s}

/* Dark toggle button */
.dm-btn{width:48px;height:48px;border:none;background:transparent;border-radius:12px;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;color:var(--t3);gap:2px;margin-bottom:4px;transition:.2s}
.dm-btn:hover{background:var(--abg);color:var(--a2)}
.dm-btn .ic{font-size:1.25rem;line-height:1}
.dm-btn .lb{font-family:'Syne',sans-serif;font-size:.4rem;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;color:var(--t3);transition:.2s}
.dm-btn:hover .lb{color:var(--a2)}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex}
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 70% 50% at 92% 4%,rgba(0,194,255,.13) 0%,transparent 60%),
             radial-gradient(ellipse 50% 60% at 4% 92%,rgba(0,144,204,.08) 0%,transparent 60%);
  pointer-events:none;z-index:0}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sb{position:relative;z-index:100;width:var(--sb);background:rgba(255,255,255,.92);
  backdrop-filter:blur(20px);border-right:1px solid var(--b2);
  display:flex;flex-direction:column;align-items:center;
  padding:20px 0;gap:2px;flex-shrink:0;
  box-shadow:2px 0 24px rgba(0,120,200,.07)}
.sb-logo{font-family:'Syne',sans-serif;font-size:.52rem;font-weight:800;
  letter-spacing:3px;color:var(--t2);text-transform:uppercase;
  margin-bottom:14px;writing-mode:vertical-rl;transform:rotate(180deg)}
.sb-logo span{color:var(--accent)}
.ni{width:48px;height:48px;border:none;background:transparent;border-radius:12px;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
  cursor:pointer;transition:.2s;position:relative;color:var(--t3);gap:2px}
.ni .ic{font-size:1.25rem;line-height:1}
.ni .lb{font-family:'Syne',sans-serif;font-size:.4rem;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;color:var(--t3);transition:.2s}
.ni:hover{background:var(--abg);color:var(--a2)}
.ni:hover .lb{color:var(--a2)}
.ni.active{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(0,194,255,.35)}
.ni.active .lb{color:rgba(255,255,255,.8)}
.ni[data-p=logout]{margin-top:auto}
.ni[data-p=logout]:hover{background:var(--dbg);color:var(--danger)}
.ni::before{content:attr(title);position:absolute;left:calc(100% + 10px);
  background:var(--text);color:#fff;padding:5px 10px;border-radius:6px;
  font-size:.7rem;white-space:nowrap;opacity:0;pointer-events:none;
  transition:.15s;font-family:'DM Sans',sans-serif;font-weight:500;z-index:200}
.ni:hover::before{opacity:1}
.badge-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;
  background:var(--danger);border-radius:50%;display:none;
  border:2px solid rgba(255,255,255,.9)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;display:flex;overflow:hidden;position:relative;z-index:1}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{position:absolute;inset:0;overflow-y:auto;padding:36px 40px;
  opacity:0;transform:translateX(20px);pointer-events:none;
  transition:opacity .28s ease,transform .28s ease}
.panel.active{opacity:1;transform:translateX(0);pointer-events:all}
.panel::-webkit-scrollbar{width:5px}
.panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ‚îÄ‚îÄ PANEL HEADER ‚îÄ‚îÄ */
.ph{margin-bottom:28px}
.ph h1{font-family:'Syne',sans-serif;font-size:1.9rem;font-weight:800;
  letter-spacing:2px;text-transform:uppercase;line-height:1}
.ph h1 em{font-style:normal;color:var(--accent)}
.ph p{margin-top:5px;font-size:.8rem;color:var(--t3);font-weight:300}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--b2);border-radius:var(--r);
  box-shadow:var(--shadow);overflow:hidden}
.card+.card{margin-top:18px}
.ch{padding:14px 22px;border-bottom:1px solid var(--b2);background:var(--s2);
  display:flex;align-items:center;gap:10px}
.ci{width:28px;height:28px;background:var(--abg);border:1px solid rgba(0,194,255,.2);
  border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.85rem}
.ct{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--t2)}
.cb{padding:22px}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats{display:flex;gap:12px;margin-bottom:22px;flex-wrap:wrap}
.sc{flex:1;min-width:90px;background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--r);padding:14px 18px;box-shadow:var(--shadow)}
.sl{font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;
  color:var(--t3);margin-bottom:4px}
.sv{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;
  color:var(--text);line-height:1}
.sv.cw{color:var(--warn)}.sv.co{color:var(--ok)}.sv.ca{color:var(--a2)}

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.ab{display:none;padding:9px 14px;border-radius:var(--rs);
  font-size:.78rem;font-weight:500;margin-bottom:14px}
.aok{background:var(--obg);border:1px solid rgba(16,185,129,.3);
  color:#065f46;border-left:3px solid var(--ok)}
.aer{background:var(--dbg);border:1px solid rgba(255,59,92,.3);
  color:#9b1c1c;border-left:3px solid var(--danger)}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.fg{display:grid;gap:0 18px}
.fg.c2{grid-template-columns:1fr 1fr}
.fg.c3{grid-template-columns:1fr 1fr 1fr}
.fg.c4{grid-template-columns:repeat(4,1fr)}
@media(max-width:700px){.fg.c2,.fg.c3,.fg.c4{grid-template-columns:1fr}}
.fgroup{margin-bottom:14px}
.fl{display:block;font-size:.62rem;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--t3);margin-bottom:5px}
input,select,textarea{width:100%;padding:9px 12px;background:var(--s2);
  border:1.5px solid var(--border);border-radius:var(--rs);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:16px;outline:none;transition:.2s}
@media(min-width:600px){input,select,textarea{font-size:.83rem}}
select{appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237A9EC0' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 12px center;padding-right:34px}
select option{background:#fff;color:var(--text)}
input:focus,select:focus,textarea:focus{border-color:var(--accent);background:#fff;
  box-shadow:0 0 0 3px rgba(0,194,255,.11)}
input::placeholder,textarea::placeholder{color:var(--t3)}
textarea{resize:vertical;min-height:72px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{padding:8px 14px;border:none;border-radius:var(--rs);
  font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;transition:.2s;
  display:inline-flex;align-items:center;gap:5px}
.bp{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(0,194,255,.3)}
.bp:hover{background:var(--a2)}
.bs{background:var(--surface);border:1px solid var(--border);color:var(--t2)}
.bs:hover{border-color:var(--accent);color:var(--a2)}
.bd{background:var(--dbg);border:1px solid rgba(255,59,92,.2);color:var(--danger)}
.bd:hover{background:rgba(255,59,92,.15)}
.bw{background:var(--wbg);border:1px solid rgba(245,158,11,.3);color:#92400e}
.bw:hover{background:rgba(245,158,11,.15)}
.bok{background:var(--obg);border:1px solid rgba(16,185,129,.3);color:#065f46}
.bok:hover{background:rgba(16,185,129,.15)}
.btn.sm{padding:5px 9px;font-size:.58rem}
.btn:disabled{opacity:.4;cursor:not-allowed}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead{background:var(--s2)}
th{padding:9px 13px;text-align:left;font-size:.58rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--t3);
  border-bottom:1px solid var(--b2);white-space:nowrap}
th.c,td.c{text-align:center}
td{padding:10px 13px;border-bottom:1px solid var(--b2)}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:var(--s2)}
.ni2{width:70px;padding:6px 7px;background:var(--s2);border:1.5px solid var(--border);
  border-radius:6px;color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:.8rem;text-align:center;outline:none;transition:.2s}
.ni2:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,194,255,.11)}
.nlow{border-color:var(--warn)!important;color:var(--warn)}

/* ‚îÄ‚îÄ PILLS ‚îÄ‚îÄ */
.pill{display:inline-block;padding:2px 8px;border-radius:20px;
  font-size:.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.po{background:var(--obg);color:var(--ok);border:1px solid rgba(16,185,129,.3)}
.pw{background:var(--wbg);color:var(--warn);border:1px solid rgba(245,158,11,.3)}
.pa{background:var(--abg);color:var(--a2);border:1px solid rgba(0,194,255,.25)}
.pm{background:rgba(100,100,120,.07);color:var(--t3);border:1px solid var(--b2)}

/* ‚îÄ‚îÄ COLLAPSIBLE FORM ‚îÄ‚îÄ */
.cf{display:none;animation:fuD .2s ease}
.cf.show{display:block}

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
.tb{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:18px}
.loctabs{display:flex;background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--rs);overflow:hidden}
.lt{padding:8px 16px;border:none;background:transparent;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--t3);cursor:pointer;transition:.2s}
.lt.active{background:var(--accent);color:#fff}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{padding:44px 20px;text-align:center;color:var(--t3)}
.empty .ei{font-size:2rem;margin-bottom:8px}
.empty p{font-size:.78rem;font-weight:300;letter-spacing:1px}

/* ‚îÄ‚îÄ HOME ‚îÄ‚îÄ */
.hgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
  gap:14px;margin-bottom:24px}
.hcard{background:var(--surface);border:1px solid var(--b2);border-radius:var(--r);
  padding:24px 20px;cursor:pointer;transition:.25s;box-shadow:var(--shadow);
  position:relative;overflow:hidden}
.hcard::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:var(--accent);transform:scaleX(0);transform-origin:left;transition:.3s ease}
.hcard:hover::before{transform:scaleX(1)}
.hcard:hover{transform:translateY(-3px);box-shadow:var(--shadowL);
  border-color:rgba(0,194,255,.3)}
.hci{font-size:1.8rem;margin-bottom:12px;display:block}
.hct{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:800;
  letter-spacing:2px;text-transform:uppercase;color:var(--text);margin-bottom:4px}
.hcd{font-size:.75rem;color:var(--t3);font-weight:300;line-height:1.45}
.wbar{background:var(--surface);border:1px solid var(--b2);border-radius:var(--r);
  padding:24px 28px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:var(--shadow);margin-bottom:24px;flex-wrap:wrap;gap:12px}
.wname{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;
  letter-spacing:2px;text-transform:uppercase}
.wemail{font-size:.75rem;color:var(--t3);margin-top:2px}
.vbadge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;
  border-radius:20px;background:var(--abg);border:1px solid rgba(0,194,255,.25);
  font-size:.65rem;font-weight:700;letter-spacing:1px;color:var(--a2);
  font-family:'Syne',sans-serif;text-transform:uppercase}

/* ‚îÄ‚îÄ COSTEO ‚îÄ‚îÄ */
.cres{text-align:center;padding:18px;background:var(--s2);
  border-radius:var(--rs);border:1px solid var(--b2);margin-bottom:14px}
.cres .cl{font-size:.6rem;color:var(--t3);font-weight:700;
  letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.cres .cv{font-family:'Syne',sans-serif;font-size:1.9rem;font-weight:800;color:var(--text)}
.cres .cv.ca{color:var(--a2)}
.frow{display:flex;justify-content:space-between;padding:5px 0;
  font-size:.78rem;color:var(--t2);border-bottom:1px solid var(--b2)}
.frow:last-child{border-bottom:none;font-weight:700;color:var(--a2)}
.iline{display:flex;justify-content:space-between;align-items:center;
  padding:9px 12px;background:var(--s2);border:1px solid var(--b2);
  border-radius:var(--rs);margin-bottom:7px;font-size:.8rem}
.iline .in{color:var(--t2)}.iline .is{font-size:.7rem;color:var(--t3)}
.iline .ic2{font-weight:700;color:var(--a2)}

/* ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ */
.rgrid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:1100px){.rgrid{grid-template-columns:1fr}}
.rcard{background:var(--s2);border:1px solid var(--b2);border-radius:var(--rs);
  padding:16px;transition:.2s;margin-bottom:10px}
.rcard:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(0,194,255,.1)}
.rname{font-family:'Syne',sans-serif;font-size:.85rem;font-weight:700;margin-bottom:5px}
.rrow{display:flex;justify-content:space-between;padding:4px 0;
  border-bottom:1px solid var(--b2);font-size:.75rem;color:var(--t2)}
.rrow:last-child{border-bottom:none}
.rcost{color:var(--a2);font-size:.68rem;font-weight:700}
.pgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;margin-top:5px}
.po2{background:var(--s2);border:2px solid var(--border);border-radius:var(--rs);
  padding:9px 4px;text-align:center;cursor:pointer;transition:.2s}
.po2:hover{border-color:var(--accent)}
.po2.sel{border-color:var(--accent);background:var(--abg)}
.po2 .pi{font-size:1.2rem;display:block;margin-bottom:3px}
.po2 .pn{font-size:.58rem;font-weight:700;letter-spacing:1px;
  text-transform:uppercase;color:var(--t2)}
.po2.sel .pn{color:var(--a2)}
.ing-ac{position:relative;flex:1}
.ing-ac-list{position:absolute;top:100%;left:0;right:0;z-index:500;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--rs);
  box-shadow:var(--shadowL);max-height:180px;overflow-y:auto;display:none}
.ing-ac-list.show{display:block}
.ing-ac-item{padding:8px 12px;font-size:.8rem;cursor:pointer;display:flex;
  align-items:center;gap:8px;border-bottom:1px solid var(--b2);transition:.15s}
.ing-ac-item:last-child{border-bottom:none}
.ing-ac-item:hover{background:var(--abg);color:var(--a2)}
.ing-ac-item .ac-badge{font-size:.6rem;background:var(--s2);border:1px solid var(--b2);
  border-radius:20px;padding:1px 6px;color:var(--t3);white-space:nowrap}
.ing-ac-item .ac-custom{color:var(--ok);font-size:.75rem;font-style:italic}
.ingrow{display:grid;grid-template-columns:2fr 80px 90px auto auto;
  gap:7px;align-items:center;margin-bottom:7px;
  background:var(--s2);border:1px solid var(--b2);
  border-radius:var(--rs);padding:9px 11px}
.icd{font-size:.68rem;color:var(--a2);font-weight:600;white-space:nowrap}
.brm{width:26px;height:26px;border:1px solid rgba(255,59,92,.2);
  background:var(--dbg);border-radius:6px;color:var(--danger);
  cursor:pointer;font-size:.85rem;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;transition:.2s}
.brm:hover{background:rgba(255,59,92,.15)}
.badd{width:100%;padding:8px;background:var(--abg);
  border:1.5px dashed rgba(0,194,255,.4);border-radius:var(--rs);
  color:var(--a2);font-family:'DM Sans',sans-serif;font-size:.75rem;
  font-weight:600;cursor:pointer;transition:.2s;margin-top:3px}
.badd:hover{background:rgba(0,194,255,.14)}
.cprev{background:var(--abg);border:1px solid rgba(0,194,255,.2);
  border-radius:var(--rs);padding:11px 15px;
  display:flex;justify-content:space-between;align-items:center;margin:10px 0}
.cpl{font-size:.6rem;color:var(--t3);font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase}
.cpv{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:800;color:var(--a2)}

/* ‚îÄ‚îÄ ACADEMIA ‚îÄ‚îÄ */
.tpills{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px}
.tp{padding:6px 14px;border:1px solid var(--border);border-radius:20px;
  background:var(--s2);font-size:.68rem;font-weight:600;letter-spacing:1px;
  text-transform:uppercase;cursor:pointer;color:var(--t2);transition:.2s;
  font-family:'DM Sans',sans-serif}
.tp:hover{border-color:var(--accent);color:var(--a2)}
.tp.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.acs{display:none}
.acs.active{display:block}
.acgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.acc{background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--rs);padding:18px;transition:.2s;box-shadow:var(--shadow)}
.acc:hover{border-color:var(--accent);transform:translateY(-2px)}
.acci{font-size:1.6rem;margin-bottom:8px}
.acct{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.accd{font-size:.75rem;color:var(--t3);line-height:1.5;white-space:pre-line}
.glgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.gli{background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--rs);padding:14px 18px}
.glt{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  letter-spacing:1.5px;text-transform:uppercase;color:var(--a2);margin-bottom:4px}
.gld{font-size:.77rem;color:var(--t2);line-height:1.5}
.ccard{background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--r);padding:18px;box-shadow:var(--shadow);margin-bottom:12px}
.ccard h3{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--t2);margin-bottom:10px}
.crow{display:flex;justify-content:space-between;padding:5px 0;
  border-bottom:1px solid var(--b2);font-size:.78rem}
.crow:last-child{border-bottom:none}
.cf2{color:var(--t2)}.ct2{color:var(--a2);font-weight:600}
.tipgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.tc{background:var(--surface);border:1px solid var(--b2);
  border-radius:var(--rs);padding:16px 18px;transition:.2s}
.tc:hover{border-color:var(--accent)}
.tt{font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;margin-bottom:5px;color:var(--text)}
.td{font-size:.77rem;color:var(--t3);line-height:1.5}

/* ‚îÄ‚îÄ AGENDA ‚îÄ‚îÄ */
.acard{background:var(--s2);border:1px solid var(--b2);border-radius:var(--rs);
  padding:13px 14px;display:flex;align-items:flex-start;gap:10px;
  margin-bottom:9px;transition:.2s}
.acard:hover{border-color:var(--accent)}
.ach{cursor:pointer;font-size:1.1rem;flex-shrink:0}
.at{font-weight:600;font-size:.85rem;margin-bottom:3px}
.am{display:flex;gap:8px;flex-wrap:wrap}
.ami{font-size:.7rem;color:var(--t3);display:flex;gap:3px;align-items:center}
.ualerts{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));
  gap:10px;margin-bottom:18px}
.ualert{background:var(--dbg);border:1px solid rgba(255,59,92,.3);
  border-radius:var(--rs);padding:12px 14px}
.ualert.w{background:var(--wbg);border-color:rgba(245,158,11,.3)}
.uat{font-family:'Syne',sans-serif;font-size:.6rem;font-weight:800;
  letter-spacing:2px;text-transform:uppercase;color:var(--danger);margin-bottom:3px}
.ualert.w .uat{color:var(--warn)}
.uad{font-size:.78rem;color:var(--text)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.mo{position:fixed;inset:0;background:rgba(10,22,40,.48);
  backdrop-filter:blur(4px);z-index:500;
  display:none;align-items:center;justify-content:center}
.mo.show{display:flex;animation:fI .2s ease}
.mb{background:var(--surface);border:1px solid var(--b2);border-radius:var(--r);
  box-shadow:var(--shadowL);width:100%;max-width:460px;max-height:90vh;
  overflow-y:auto;animation:sU .28s ease}
.mh{padding:18px 22px;border-bottom:1px solid var(--b2);
  display:flex;align-items:center;justify-content:space-between}
.mh h3{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase}
.mc{width:26px;height:26px;border:none;background:var(--s2);
  border-radius:6px;cursor:pointer;font-size:.95rem;color:var(--t3);
  display:flex;align-items:center;justify-content:center;transition:.2s}
.mc:hover{background:var(--dbg);color:var(--danger)}
.mbody{padding:22px}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#ls{position:fixed;inset:0;z-index:9999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
.ll{font-family:'Syne',sans-serif;font-size:2.8rem;font-weight:800;
  letter-spacing:6px;text-transform:uppercase;color:var(--text);
  animation:pls 1.4s ease-in-out infinite}
.ll span{color:var(--accent)}
.ls2{font-size:.7rem;color:var(--t3);letter-spacing:3px;text-transform:uppercase}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#loginScreen{position:fixed;inset:0;z-index:9998;background:var(--bg);
  display:none;align-items:center;justify-content:center;overflow-y:auto;padding:20px}
#loginScreen.show{display:flex}
.lgs-wrap{width:100%;max-width:440px}
.lgs-logo{text-align:center;margin-bottom:32px}
.lgs-logo .ll{animation:none;font-size:2.4rem}
.lgs-logo p{font-size:.72rem;color:var(--t3);letter-spacing:3px;text-transform:uppercase;margin-top:6px}
.lgs-card{background:var(--surface);border:1px solid var(--b2);border-radius:var(--r);
  box-shadow:var(--shadowL);overflow:hidden}
.lgs-tabs{display:flex;background:var(--s2);border-bottom:1px solid var(--b2)}
.lgs-tab{flex:1;padding:13px;border:none;background:transparent;
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;color:var(--t3);cursor:pointer;transition:.2s}
.lgs-tab.active{background:var(--surface);color:var(--accent);
  border-bottom:2px solid var(--accent)}
.lgs-body{padding:28px}
.lgs-title{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:800;
  letter-spacing:3px;text-transform:uppercase;color:var(--t2);margin-bottom:20px;text-align:center}
.lgs-form{display:none}
.lgs-form.active{display:block}
.lgs-alert{display:none;padding:10px 14px;border-radius:var(--rs);font-size:.78rem;
  font-weight:500;margin-bottom:16px}
.lgs-alert.show{display:block}
.lgs-alert.err{background:var(--dbg);border:1px solid rgba(255,59,92,.3);
  color:var(--danger);border-left:3px solid var(--danger)}
.lgs-alert.ok{background:var(--obg);border:1px solid rgba(16,185,129,.3);
  color:var(--ok);border-left:3px solid var(--ok)}
.lgs-alert.info{background:var(--abg);border:1px solid rgba(0,194,255,.25);
  color:var(--a2);border-left:3px solid var(--accent)}
.lgs-btn{width:100%;padding:11px;background:var(--accent);color:#fff;border:none;
  border-radius:var(--rs);font-family:'Syne',sans-serif;font-size:.65rem;font-weight:700;
  letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:.2s;margin-top:4px;
  box-shadow:0 4px 14px rgba(0,194,255,.3)}
.lgs-btn:hover{background:var(--a2)}
.lgs-btn:disabled{opacity:.5;cursor:not-allowed}
.lgs-link{background:none;border:none;color:var(--a2);font-size:.72rem;cursor:pointer;
  display:block;text-align:center;margin-top:12px;font-family:'DM Sans',sans-serif;
  text-decoration:underline}
.lgs-link:hover{color:var(--accent)}
.lgs-back{background:var(--s2);color:var(--t2);border:1px solid var(--b2);margin-top:8px;
  box-shadow:none}
.lgs-back:hover{background:var(--abg);color:var(--a2)}

/* ‚îÄ‚îÄ FILTER PILLS ‚îÄ‚îÄ */
.fps{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px}
.fp{padding:5px 11px;border:1px solid var(--border);border-radius:20px;
  background:var(--s2);font-size:.62rem;font-weight:600;
  letter-spacing:1px;text-transform:uppercase;cursor:pointer;
  color:var(--t2);transition:.2s;font-family:'DM Sans',sans-serif}
.fp:hover{border-color:var(--accent);color:var(--a2)}
.fp.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
.sw{margin-bottom:12px}
.sw input{padding-left:34px;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='13' height='13' viewBox='0 0 24 24' fill='none' stroke='%237A9EC0' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:11px center}

.sub{font-size:.68rem;color:var(--t3);margin-top:2px}

@keyframes pls{0%,100%{opacity:1}50%{opacity:.45}}
@keyframes fuD{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes fI{from{opacity:0}to{opacity:1}}
@keyframes sU{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="ls">
  <div class="ll">MIX<span>LY</span></div>
  <div class="ls2">Iniciando sesi√≥n‚Ä¶</div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="lgs-wrap">
    <div class="lgs-logo">
      <div class="ll">MIX<span>LY</span></div>
      <p>Sistema de Gesti√≥n de Bar</p>
    </div>
    <div class="lgs-card">
      <div class="lgs-tabs" id="lgsTabs">
        <button class="lgs-tab active" onclick="lgsTab('login')">Iniciar Sesi√≥n</button>
        <button class="lgs-tab" onclick="lgsTab('register')">Registrarse</button>
      </div>
      <div class="lgs-body">
        <div id="lgsAlert" class="lgs-alert"></div>

        <!-- Login -->
        <div id="lgsLogin" class="lgs-form active">
          <div class="lgs-title">Bienvenido de vuelta</div>
          <div class="fgroup"><label class="fl">Correo</label>
            <input type="email" id="lgsEmail" placeholder="tu@correo.com"/></div>
          <div class="fgroup"><label class="fl">Contrase√±a</label>
            <input type="password" id="lgsPass" placeholder="Tu contrase√±a"/></div>
          <button class="lgs-btn" onclick="lgsLogin()">Entrar ‚Üí</button>
          <button class="lgs-link" onclick="lgsTab('forgot')">¬øOlvidaste tu contrase√±a?</button>
        </div>

        <!-- Register -->
        <div id="lgsRegister" class="lgs-form">
          <div class="lgs-title">Crear cuenta nueva</div>
          <div class="fgroup"><label class="fl">Correo *</label>
            <input type="email" id="lgsRegEmail" placeholder="tu@correo.com"/></div>
          <div class="fgroup"><label class="fl">Nombre del Bar *</label>
            <input type="text" id="lgsBarName" placeholder="Ej: Bar El Mojito"/></div>
          <div class="fgroup"><label class="fl">Tu nombre *</label>
            <input type="text" id="lgsUsername" placeholder="Tu nombre o apodo"/></div>
          <div class="fgroup"><label class="fl">Contrase√±a *</label>
            <input type="password" id="lgsRegPass" placeholder="M√≠nimo 6 caracteres"/></div>
          <div class="fgroup"><label class="fl">Confirmar contrase√±a *</label>
            <input type="password" id="lgsRegPass2" placeholder="Repite tu contrase√±a"/></div>
          <button class="lgs-btn" onclick="lgsRegister()">Crear cuenta</button>
        </div>

        <!-- Forgot -->
        <div id="lgsForgot" class="lgs-form">
          <div class="lgs-title">Recuperar contrase√±a</div>
          <div class="fgroup"><label class="fl">Correo</label>
            <input type="email" id="lgsForgotEmail" placeholder="tu@correo.com"/></div>
          <button class="lgs-btn" onclick="lgsForgot()">Enviar enlace</button>
          <button class="lgs-btn lgs-back" onclick="lgsTab('login')">‚Üê Volver</button>
        </div>

        <!-- Reset -->
        <div id="lgsReset" class="lgs-form">
          <div class="lgs-title">üîê Nueva contrase√±a</div>
          <div class="fgroup"><label class="fl">Nueva contrase√±a</label>
            <input type="password" id="lgsNewPass" placeholder="M√≠nimo 6 caracteres"/></div>
          <div class="fgroup"><label class="fl">Confirmar</label>
            <input type="password" id="lgsNewPass2" placeholder="Repite tu contrase√±a"/></div>
          <button class="lgs-btn" onclick="lgsUpdatePass()">Actualizar contrase√±a</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<nav class="sb" id="sidebar" style="display:none">
  <div class="sb-logo">MIX<span>LY</span></div>
  <button class="ni active" data-p="home"      title="Inicio"><span class="ic">üè†</span><span class="lb">Inicio</span></button>
  <button class="ni" data-p="productos"        title="Productos"><span class="ic">üì¶</span><span class="lb">Prod.</span></button>
  <button class="ni" data-p="inventory"        title="Inventario"><span class="ic">üìä</span><span class="lb">Stock</span></button>
  <button class="ni" data-p="recipes"          title="Recetario"><span class="ic">üìñ</span><span class="lb">Recetas</span></button>
  <button class="ni" data-p="costeo"           title="Costeo"><span class="ic">üí∞</span><span class="lb">Costeo</span></button>
  <button class="ni" data-p="agenda"           title="Agenda">
    <span class="ic">üìÖ</span><span class="lb">Agenda</span>
    <span class="badge-dot" id="bdot"></span>
  </button>
  <button class="ni" data-p="academy"          title="Academia"><span class="ic">üéì</span><span class="lb">Acad.</span></button>
  <button class="ni" data-p="buscador"         title="Buscador"><span class="ic">üîç</span><span class="lb">Buscar</span></button>
  <button class="ni" data-p="timers"           title="Timers"><span class="ic">‚è±</span><span class="lb">Timers</span></button>
  <button class="ni" data-p="fichas"           title="Fichas t√©cnicas"><span class="ic">üìã</span><span class="lb">Fichas</span></button>
  <button class="dm-btn" id="dmToggle" title="Modo oscuro" onclick="toggleDM()">
    <span class="ic" id="dmIc">üåô</span>
    <span class="lb" id="dmLb">Dark</span>
  </button>
  <button class="ni" data-p="logout" title="Cerrar sesi√≥n" style="margin-top:auto"><span class="ic">‚éã</span><span class="lb">Salir</span></button>
</nav>

<!-- ONBOARDING OVERLAY -->
<div id="obOverlay">
  <div class="ob-backdrop" onclick="obSkip()"></div>
  <div class="ob-spotlight" id="obSpot"></div>
  <div class="ob-card" id="obCard">
    <div class="ob-header">
      <div class="ob-emoji" id="obEmoji">üëã</div>
      <div class="ob-title" id="obTitle">Bienvenido a Mixly</div>
      <div class="ob-sub" id="obSub">Tu asistente de bar favorito</div>
    </div>
    <div class="ob-body">
      <div class="ob-progress" id="obProgress"></div>
      <div class="ob-desc" id="obDesc"></div>
      <div class="ob-tip" id="obTip"></div>
    </div>
    <div class="ob-footer">
      <button class="ob-skip" onclick="obSkip()">Saltar tour</button>
      <div class="ob-nav">
        <button class="btn bs sm" id="obPrev" onclick="obStep(-1)">‚Üê Anterior</button>
        <button class="btn bp sm" id="obNext" onclick="obStep(1)">Siguiente ‚Üí</button>
      </div>
    </div>
  </div>
</div>
<button id="obHelpBtn" onclick="startOB(true)" title="Ver tour de bienvenida">?</button>

<!-- MAIN -->
<div class="main" id="mainApp" style="display:none">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel-home">
  <div class="ph"><h1>Dash<em>board</em></h1><p>Tu centro de operaciones Mixly</p></div>
  <div class="wbar">
    <div><div class="wname" id="wname">Mi Bar</div><div class="wemail" id="wemail"></div></div>
    <div class="vbadge">üç∏ Mixly v2.0</div>
  </div>
  <div class="hgrid">
    <div class="hcard" onclick="sp('productos')"><span class="hci">üì¶</span><div class="hct">Productos</div><div class="hcd">Cat√°logo central de licores, frutas e insumos</div></div>
    <div class="hcard" onclick="sp('inventory')"><span class="hci">üìä</span><div class="hct">Inventario</div><div class="hcd">Control de stock Barra & Bodega en tiempo real</div></div>
    <div class="hcard" onclick="sp('recipes')"><span class="hci">üìñ</span><div class="hct">Recetario</div><div class="hcd">Recetas con costo calculado autom√°ticamente</div></div>
    <div class="hcard" onclick="sp('costeo')"><span class="hci">üí∞</span><div class="hct">Costeo</div><div class="hcd">M√°rgenes, precios sugeridos con IVA</div></div>
    <div class="hcard" onclick="sp('agenda')"><span class="hci">üìÖ</span><div class="hct">Agenda</div><div class="hcd">Recordatorios de proveedores y tareas</div></div>
    <div class="hcard" onclick="sp('academy')"><span class="hci">üéì</span><div class="hct">Academia</div><div class="hcd">T√©cnicas, glosario y recetas cl√°sicas</div></div>
  </div>
  <div class="stats">
    <div class="sc"><div class="sl">Productos</div><div class="sv ca" id="hs-p">‚Äî</div></div>
    <div class="sc"><div class="sl">Inventario</div><div class="sv" id="hs-i">‚Äî</div></div>
    <div class="sc"><div class="sl">Stock bajo</div><div class="sv cw" id="hs-l">‚Äî</div></div>
    <div class="sc"><div class="sl">Recetas</div><div class="sv co" id="hs-r">‚Äî</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-productos">
  <div class="ph"><h1>Prod<em>uctos</em></h1><p>Cat√°logo maestro ¬∑ fuente de verdad √∫nica ¬∑ incluye proveedor, stock m√≠nimo y precio/unidad</p></div>
  <div id="p-ok" class="ab aok"></div><div id="p-er" class="ab aer"></div>
  <div class="tb">
    <button class="btn bp" onclick="tPF(true)">Ôºã Nuevo producto</button>
    <label class="btn bok" style="cursor:pointer;display:inline-flex;align-items:center;gap:5px" title="Importar cat√°logo desde Excel (formato Mixly)">
      ‚Üë Importar Excel
      <input type="file" id="pImport" accept=".xlsx,.xls" style="display:none" onchange="importXLS(this)"/>
    </label>
    <button class="btn bs" onclick="expCatalogo()" title="Exportar cat√°logo completo con todos los datos">‚Üì Exportar cat√°logo</button>
    <button class="btn bs" onclick="expCatalogoShare()" title="Exportar en formato para compartir con otro usuario de Mixly">üì§ Compartir cat√°logo</button>
    <div class="sw" style="margin-bottom:0;flex:1;max-width:280px"><input id="pSearch" placeholder="Buscar producto‚Ä¶" oninput="renderP()"/></div>
    <div class="loctabs" id="pCatFilter">
      <button class="lt active" data-cat="all">Todos</button>
      <button class="lt" data-cat="Bebida">Bebidas</button>
      <button class="lt" data-cat="Cerveza">Cervezas</button>
      <button class="lt" data-cat="Pisco">Pisco</button>
      <button class="lt" data-cat="Ron">Ron</button>
      <button class="lt" data-cat="Tequila">Tequila</button>
      <button class="lt" data-cat="Vodka">Vodka</button>
      <button class="lt" data-cat="Whiskey">Whiskey</button>
      <button class="lt" data-cat="Vino">Vino</button>
      <button class="lt" data-cat="Gin">Gin</button>
      <button class="lt" data-cat="Licor">Licores</button>
      <button class="lt" data-cat="Fruta">Frutas</button>
      <button class="lt" data-cat="Insumo">Insumos</button>
      <button class="lt" data-cat="Base">Bases</button>
    </div>
  </div>

  <div class="cf card" id="pForm" style="margin-bottom:18px">
    <div class="ch"><div class="ci">üì¶</div><div class="ct" id="pFT">Nuevo producto</div></div>
    <div class="cb">
      <!-- Fila 1: Identidad + Proveedor -->
      <div class="fg c3" style="margin-bottom:0">
        <div class="fgroup"><label class="fl">Nombre del producto</label><input id="pN" placeholder="Ej: Pisco Capel 35¬∞"/></div>
        <div class="fgroup"><label class="fl">Categor√≠a</label>
          <select id="pC">
            <option value="">Seleccionar‚Ä¶</option>
            <option value="Bebida">Bebida</option>
            <option value="Cerveza">Cerveza</option>
            <option value="Pisco">Pisco</option>
            <option value="Ron">Ron</option>
            <option value="Tequila">Tequila</option>
            <option value="Vodka">Vodka</option>
            <option value="Whiskey">Whiskey</option>
            <option value="Vino">Vino</option>
            <option value="Gin">Gin</option>
            <option value="Licor">Licor</option>
            <option value="Fruta">Fruta</option>
            <option value="Insumo">Insumo</option>
            <option value="Base">Base</option>
          </select>
        </div>
        <div class="fgroup"><label class="fl">Proveedor</label><input id="pProv" placeholder="Ej: Distribuidora Norte"/></div>
      </div>
      <!-- Fila 2: Cantidad, unidad, precio, precio/unidad -->
      <div class="fg c4" style="margin-bottom:0">
        <div class="fgroup"><label class="fl">Cantidad total</label><input type="number" id="pQ" placeholder="750" min="0.001" step="any" oninput="upPH()"/></div>
        <div class="fgroup"><label class="fl">Unidad</label>
          <select id="pU" onchange="upPH()">
            <option value="">Unidad‚Ä¶</option>
            <option value="ml">ml ‚Äî mililitros</option>
            <option value="lt">lt ‚Äî litros</option>
            <option value="gr">gr ‚Äî gramos</option>
            <option value="kg">kg ‚Äî kilos</option>
            <option value="un">un ‚Äî unidad</option>
          </select>
        </div>
        <div class="fgroup"><label class="fl">Precio total ($)</label><input type="number" id="pP" placeholder="10000" min="0" step="any" oninput="upPH()"/></div>
        <div class="fgroup"><label class="fl">Stock m√≠nimo</label><input type="number" id="pMinSt" placeholder="2" min="0" step="any"/></div>
        <div class="fgroup" style="grid-column:1/-1">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.8rem;color:var(--t2)">
            <input type="checkbox" id="pSkipInv" style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer"/>
            <span><strong>No aparece en inventario</strong> ‚Äî solo disponible en recetas (bases, jarabes caseros, etc.)</span>
          </label>
        </div>
      </div>
      <!-- Precio/unidad calculado + botones -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-top:10px">
        <div id="pHint" style="font-size:.82rem;color:var(--a2);font-weight:700;padding:9px 16px;background:var(--abg);border:1px solid rgba(0,194,255,.2);border-radius:var(--rs)">
          Precio / unidad: ‚Äî
        </div>
        <div class="row">
          <button class="btn bp" onclick="saveP()">Guardar producto</button>
          <button class="btn bs" onclick="tPF(false)">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ch"><div class="ci">‚ò∞</div><div class="ct">Listado de productos</div>
      <span id="pCount" style="margin-left:auto;font-size:.65rem;color:var(--t3);font-weight:600"></span>
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th>Producto</th><th>Categor√≠a</th><th>Proveedor</th>
        <th class="c">Cantidad</th><th class="c">Unidad</th>
        <th class="c">Precio total</th><th class="c">Precio/unidad</th>
        <th class="c">Stock m√≠n.</th><th class="c">Acciones</th>
      </tr></thead>
      <tbody id="pTb"></tbody>
    </table></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVENTARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-inventory">
  <div class="ph"><h1>Inv<em>entario</em></h1><p>Stock de Barra & Bodega ¬∑ proveedor y stock m√≠nimo migran autom√°ticamente desde Productos</p></div>
  <div id="i-ok" class="ab aok"></div><div id="i-er" class="ab aer"></div>
  <div class="stats">
    <div class="sc"><div class="sl">Productos</div><div class="sv" id="iT">0</div></div>
    <div class="sc"><div class="sl">Stock bajo</div><div class="sv cw" id="iL">0</div></div>
    <div class="sc"><div class="sl">Sin stock</div><div class="sv" style="color:var(--danger)" id="iZ">0</div></div>
    <div class="sc"><div class="sl">Para pedir</div><div class="sv co" id="iP">0</div></div>
  </div>
  <div class="tb">
    <div class="loctabs">
      <button class="lt active" data-loc="barra">üç∏ Barra</button>
      <button class="lt" data-loc="bodega">üì¶ Bodega</button>
    </div>
    <button class="btn bs" id="iUndo" disabled onclick="undoI()">‚Ü∫ Deshacer</button>
    <button class="btn bok" onclick="expInv()">‚Üì Excel</button>
    <button class="btn bw" onclick="resetI()">üîÑ Vaciar stock</button>
  </div>

  <div class="card">
    <div class="ch"><div class="ci">‚ò∞</div>
      <div class="ct">Stock actual ¬∑ <span id="iLL" style="color:var(--accent)">Barra</span></div>
      <span id="iLowWarn" style="margin-left:auto;font-size:.65rem;color:var(--warn);font-weight:700;display:none">‚ö† Hay productos bajo el m√≠nimo</span>
    </div>
    <div class="tw"><table>
      <thead><tr>
        <th>Producto</th><th>Categor√≠a</th><th>Proveedor</th>
        <th class="c">Stock <span id="iLB" style="color:var(--accent);font-size:.58rem">BARRA</span></th>
        <th class="c">Unidad</th><th class="c">Stock m√≠n.</th>
        <th class="c">A pedir</th>
      </tr></thead>
      <tbody id="iTb"></tbody>
    </table></div>
  </div>
  <div style="margin-top:12px;padding:11px 15px;background:var(--abg);border:1px solid rgba(0,194,255,.18);border-radius:var(--rs);font-size:.72rem;color:var(--t2)">
    üí° Para cambiar nombre, precio, proveedor o stock m√≠nimo de un producto, ed√≠talo en <strong><a href="javascript:sp('productos')" style="color:var(--a2);text-decoration:none">üì¶ Productos</a></strong> ‚Äî el inventario lo hereda autom√°ticamente.
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECETARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-recipes">
  <div class="ph"><h1>Rece<em>tario</em></h1><p>Crea c√≥cteles del cat√°logo ¬∑ costo calculado en tiempo real</p></div>
  <div class="rgrid">
    <div class="card">
      <div class="ch"><div class="ci">üçπ</div><div class="ct">Nueva receta</div></div>
      <div class="cb">
        <div class="fgroup"><label class="fl">Nombre del c√≥ctel</label><input id="rN" placeholder="Ej: Mojito Cl√°sico"/></div>
        <div class="fgroup"><label class="fl">Descripci√≥n</label><textarea id="rD" placeholder="Describe tu c√≥ctel‚Ä¶" style="min-height:54px"></textarea></div>
        <div class="fgroup">
          <label class="fl">Ingredientes</label>
          <div id="rIC"></div>
          <button class="badd" onclick="addRI()">Ôºã Agregar ingrediente</button>
        </div>
        <div class="cprev" id="rCP" style="display:none">
          <div><div class="cpl">Costo estimado</div><div style="font-size:.65rem;color:var(--t3)">precio/ml del cat√°logo</div></div>
          <div class="cpv" id="rCT">$0</div>
        </div>
        <div class="fgroup"><label class="fl">Preparaci√≥n</label><textarea id="rPr" placeholder="1. Hielo‚Ä¶&#10;2. Verter‚Ä¶"></textarea></div>
        <div class="fgroup">
          <label class="fl">Color de ficha</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button type="button" class="rcol-btn" data-col="#00C2FF" onclick="selCol('#00C2FF',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#00C2FF,#0090CC);border:3px solid var(--accent);cursor:pointer;flex-shrink:0" title="Cyan"></button>
            <button type="button" class="rcol-btn" data-col="#FF4D6A" onclick="selCol('#FF4D6A',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#FF4D6A,#cc0033);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Rojo"></button>
            <button type="button" class="rcol-btn" data-col="#FF9800" onclick="selCol('#FF9800',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#FF9800,#e65100);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Naranja"></button>
            <button type="button" class="rcol-btn" data-col="#FBBF24" onclick="selCol('#FBBF24',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#FBBF24,#b45309);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Amarillo"></button>
            <button type="button" class="rcol-btn" data-col="#34D399" onclick="selCol('#34D399',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#34D399,#065f46);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Verde"></button>
            <button type="button" class="rcol-btn" data-col="#818CF8" onclick="selCol('#818CF8',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#818CF8,#3730a3);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="√çndigo"></button>
            <button type="button" class="rcol-btn" data-col="#F472B6" onclick="selCol('#F472B6',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#F472B6,#9d174d);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Rosa"></button>
            <button type="button" class="rcol-btn" data-col="#A78BFA" onclick="selCol('#A78BFA',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#A78BFA,#5b21b6);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Morado"></button>
            <button type="button" class="rcol-btn" data-col="#2DD4BF" onclick="selCol('#2DD4BF',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#2DD4BF,0f766e);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Teal"></button>
            <button type="button" class="rcol-btn" data-col="#6B7280" onclick="selCol('#6B7280',this)" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#6B7280,#1f2937);border:2px solid transparent;cursor:pointer;flex-shrink:0" title="Gris"></button>
          </div>
        </div>
        <div class="fgroup">
          <label class="fl">Perfil de sabor</label>
          <div class="pgrid">
            <div class="po2" data-p="dulce"        onclick="selP('dulce')"><span class="pi">üç¨</span><span class="pn">Dulce</span></div>
            <div class="po2" data-p="suave"        onclick="selP('suave')"><span class="pi">üå∏</span><span class="pn">Suave</span></div>
            <div class="po2" data-p="seco"         onclick="selP('seco')"><span class="pi">üçã</span><span class="pn">Seco</span></div>
            <div class="po2" data-p="fuerte"       onclick="selP('fuerte')"><span class="pi">üî•</span><span class="pn">Fuerte</span></div>
            <div class="po2" data-p="extra-fuerte" onclick="selP('extra-fuerte')"><span class="pi">üí•</span><span class="pn">Extra</span></div>
          </div>
        </div>
        <button class="btn bp" style="width:100%;padding:11px;margin-top:6px" onclick="saveR()">Guardar receta</button>
      </div>
    </div>
    <div class="card">
      <div class="ch"><div class="ci">üìñ</div><div class="ct">Mis recetas</div></div>
      <div class="cb">
        <div class="sw"><input id="rSrch" placeholder="Buscar recetas‚Ä¶" oninput="renderR()"/></div>
        <div class="fps">
          <button class="fp active" data-f="all"         onclick="setRF('all',this)">Todas</button>
          <button class="fp" data-f="dulce"              onclick="setRF('dulce',this)">üç¨ Dulce</button>
          <button class="fp" data-f="suave"              onclick="setRF('suave',this)">üå∏ Suave</button>
          <button class="fp" data-f="seco"               onclick="setRF('seco',this)">üçã Seco</button>
          <button class="fp" data-f="fuerte"             onclick="setRF('fuerte',this)">üî• Fuerte</button>
          <button class="fp" data-f="extra-fuerte"       onclick="setRF('extra-fuerte',this)">üí• Extra</button>
        </div>
        <div id="rList"><div class="empty"><div class="ei">üçπ</div><p>No hay recetas guardadas</p></div></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COSTEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-costeo">
  <div class="ph"><h1>Cos<em>teo</em></h1><p>Costo real y precio sugerido con m√°rgenes e IVA chileno</p></div>
  <div class="fg c3" style="margin-bottom:18px">
    <div class="fgroup"><label class="fl">Nombre del c√≥ctel</label><input id="cNom" placeholder="Ej: Mojito"/></div>
    <div class="fgroup"><label class="fl">Margen</label>
      <select id="cMar" onchange="rcalc()">
        <option value="3">Margen √ó3</option><option value="4">Margen √ó4</option>
        <option value="5" selected>Margen √ó5</option><option value="6">Margen √ó6</option>
      </select>
    </div>
    <div class="fgroup"><label class="fl" style="visibility:hidden">‚Äî</label>
      <button class="btn bok" style="width:100%;height:37px" onclick="expCosteo()">‚Üì Exportar Excel</button>
    </div>
  </div>
  <div class="card" style="margin-bottom:18px">
    <div class="ch"><div class="ci">Ôºã</div><div class="ct">Agregar ingrediente</div></div>
    <div class="cb">
      <div class="fg c4" style="align-items:end">
        <div class="fgroup"><label class="fl">Categor√≠a</label>
          <select id="cCat" onchange="onCcat()">
            <option value="">Categor√≠a‚Ä¶</option>
            <option value="Bebida">Bebidas</option>
            <option value="Cerveza">Cervezas</option>
            <option value="Pisco">Pisco</option>
            <option value="Ron">Ron</option>
            <option value="Tequila">Tequila</option>
            <option value="Vodka">Vodka</option>
            <option value="Whiskey">Whiskey</option>
            <option value="Vino">Vino</option>
            <option value="Gin">Gin</option>
            <option value="Licor">Licores</option>
            <option value="Fruta">Frutas</option>
            <option value="Insumo">Insumos</option>
            <option value="Base">Bases</option>
          </select>
        </div>
        <div class="fgroup"><label class="fl">Producto</label><select id="cProd"><option value="">Producto‚Ä¶</option></select></div>
        <div class="fgroup"><label class="fl">Cantidad (ml/gr)</label><input type="number" id="cQty" placeholder="30" min="1"/></div>
        <div class="fgroup" style="margin-bottom:14px">
          <button class="btn bp" style="width:100%;height:37px" onclick="addCI()">Ôºã Agregar</button>
        </div>
      </div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px">
    <div class="card"><div class="cb"><div class="cres"><div class="cl">Costo Real</div><div class="cv" id="cCR">$0</div></div></div></div>
    <div class="card"><div class="cb">
      <div class="cres"><div class="cl">Precio Sugerido</div><div class="cv ca" id="cPF">$0</div></div>
      <div id="cFormula">
        <div class="frow"><span>Costo base:</span><span id="cFB">$0</span></div>
        <div class="frow"><span>+ Operativo (10%):</span><span id="cFO">$0</span></div>
        <div class="frow"><span>√ó Margen:</span><span id="cFM">$0</span></div>
        <div class="frow"><span>+ IVA (19%):</span><span id="cFI">$0</span></div>
        <div class="frow"><span>Precio final:</span><span id="cFF">$0</span></div>
      </div>
    </div></div>
  </div>
  <div class="card">
    <div class="ch"><div class="ci">üßæ</div><div class="ct">Desglose</div></div>
    <div class="cb" id="cDesglose"><div class="empty"><div class="ei">üßæ</div><p>Agrega ingredientes para ver el desglose</p></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AGENDA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-agenda">
  <div class="ph"><h1>A<em>gen</em>da</h1><p>Recordatorios de proveedores, pedidos y tareas del bar</p></div>
  <div id="uAlerts" class="ualerts" style="display:none"></div>
  <div class="tb">
    <div class="fps" style="margin-bottom:0">
      <button class="fp active" data-ag="pending"  onclick="setAT('pending',this)">Pendientes</button>
      <button class="fp" data-ag="today"    onclick="setAT('today',this)">Hoy</button>
      <button class="fp" data-ag="week"     onclick="setAT('week',this)">Esta semana</button>
      <button class="fp" data-ag="completed" onclick="setAT('completed',this)">Completados</button>
    </div>
    <button class="btn bp" onclick="openAM()">Ôºã Nuevo</button>
  </div>
  <div id="agList"><div class="empty"><div class="ei">üìÖ</div><p>Cargando‚Ä¶</p></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACADEMIA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-academy">
  <div class="ph"><h1>Aca<em>de</em>mia</h1><p>T√©cnicas, recetas cl√°sicas, glosario y conversiones</p></div>
  <div class="sw" style="max-width:360px;margin-bottom:18px">
    <input id="acS" placeholder="Buscar t√©cnica, receta, t√©rmino‚Ä¶" oninput="filterAc()"/>
  </div>
  <div class="tpills">
    <button class="tp active" data-ac="tecnicas"       onclick="setAc('tecnicas',this)">T√©cnicas</button>
    <button class="tp" data-ac="recetas"               onclick="setAc('recetas',this)">Recetas Cl√°sicas</button>
    <button class="tp" data-ac="glosario"              onclick="setAc('glosario',this)">Glosario</button>
    <button class="tp" data-ac="conversiones"          onclick="setAc('conversiones',this)">Conversiones</button>
    <button class="tp" data-ac="tips"                  onclick="setAc('tips',this)">Tips Pro</button>
  </div>
  <div class="acs active" id="ac-tecnicas"><div class="acgrid" id="ag-tecnicas"></div></div>
  <div class="acs" id="ac-recetas"><div class="acgrid" id="ag-recetas"></div></div>
  <div class="acs" id="ac-glosario"><div class="glgrid" id="ag-glosario"></div></div>
  <div class="acs" id="ac-conversiones" id="ag-conv"></div>
  <div class="acs" id="ac-tips"><div class="tipgrid" id="ag-tips"></div></div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUSCADOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-buscador">
  <div class="ph"><h1>Bus<em>cador</em></h1><p>Encuentra cualquier receta al instante ¬∑ busca por ingrediente, nombre o perfil</p></div>
  <div class="card" style="margin-bottom:18px">
    <div class="cb" style="padding:18px 22px">
      <div style="display:flex;gap:10px;align-items:center">
        <div style="flex:1;position:relative">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1rem;pointer-events:none">üîç</span>
          <input id="bqInput" placeholder="Escribe un trago, ingrediente o perfil‚Ä¶"
            style="padding-left:38px;font-size:.95rem;height:44px"
            oninput="doSearch()"/>
        </div>
        <button class="btn bs" onclick="document.getElementById('bqInput').value='';doSearch()">‚úï Limpiar</button>
      </div>
      <div id="bqFilters" class="fps" style="margin-top:12px;margin-bottom:0">
        <button class="fp active" data-bf="all"   onclick="setBF('all',this)">Todas</button>
        <button class="fp" data-bf="dulce"        onclick="setBF('dulce',this)">üç¨ Dulce</button>
        <button class="fp" data-bf="suave"        onclick="setBF('suave',this)">üå∏ Suave</button>
        <button class="fp" data-bf="seco"         onclick="setBF('seco',this)">üçã Seco</button>
        <button class="fp" data-bf="fuerte"       onclick="setBF('fuerte',this)">üî• Fuerte</button>
        <button class="fp" data-bf="extra-fuerte" onclick="setBF('extra-fuerte',this)">üí• Extra</button>
      </div>
    </div>
  </div>
  <div id="bqStats" style="font-size:.72rem;color:var(--t3);margin-bottom:12px;padding:0 4px"></div>
  <div id="bqResults"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-timers">
  <div class="ph"><h1>Ti<em>mers</em></h1><p>Temporizadores para macerados, jarabes, infusiones y t√©cnicas</p></div>
  <div class="card" style="margin-bottom:18px">
    <div class="ch"><div class="ci">Ôºã</div><div class="ct">Nuevo timer</div></div>
    <div class="cb">
      <div class="fg c3" style="margin-bottom:0">
        <div class="fgroup"><label class="fl">Nombre</label>
          <input id="tmName" placeholder="Ej: Jarabe de jengibre"/>
        </div>
        <div class="fgroup"><label class="fl">Duraci√≥n</label>
          <div style="display:flex;gap:6px">
            <input type="number" id="tmMin" placeholder="min" min="0" style="width:70px"/>
            <input type="number" id="tmSec" placeholder="seg" min="0" max="59" style="width:70px"/>
          </div>
        </div>
        <div class="fgroup"><label class="fl">Emoji / √≠cono</label>
          <input id="tmEmoji" placeholder="üçØ" style="font-size:1.2rem;text-align:center" maxlength="4"/>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
        <span style="font-size:.68rem;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase;align-self:center">Presets:</span>
        <button class="btn bs sm" onclick="tmPreset('Jarabe 1:1',10,0,'üçØ')">üçØ Jarabe 1:1 ¬∑ 10min</button>
        <button class="btn bs sm" onclick="tmPreset('Macerado express',20,0,'üåø')">üåø Macerado ¬∑ 20min</button>
        <button class="btn bs sm" onclick="tmPreset('Reducci√≥n',15,0,'ü´ô')">ü´ô Reducci√≥n ¬∑ 15min</button>
        <button class="btn bs sm" onclick="tmPreset('Shake',0,15,'üç∏')">üç∏ Shake ¬∑ 15seg</button>
        <button class="btn bs sm" onclick="tmPreset('Stir',0,30,'ü•É')">ü•É Stir ¬∑ 30seg</button>
        <button class="btn bs sm" onclick="tmPreset('Infusi√≥n',30,0,'ü´ñ')">ü´ñ Infusi√≥n ¬∑ 30min</button>
      </div>
      <div class="row">
        <button class="btn bp" onclick="addTimer()">Ôºã Iniciar timer</button>
      </div>
    </div>
  </div>
  <div id="tmList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px"></div>
  <div id="tmEmpty" style="display:none" class="empty"><div class="ei">‚è±</div><p>No hay timers activos ¬∑ crea uno arriba</p></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FICHAS T√âCNICAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-fichas">
  <div class="ph"><h1>Fichas <em>T√©cnicas</em></h1><p>Recetas en formato profesional ¬∑ listas para imprimir o mostrar en barra</p></div>
  <div class="tb">
    <div class="sw" style="flex:1;max-width:300px;margin-bottom:0">
      <input id="fqInput" placeholder="Buscar receta‚Ä¶" oninput="renderFichas()"/>
    </div>
    <div class="fps" style="margin-bottom:0" id="fqPerfil">
      <button class="fp active" data-fp2="all"   onclick="setFP2('all',this)">Todas</button>
      <button class="fp" data-fp2="dulce"        onclick="setFP2('dulce',this)">üç¨</button>
      <button class="fp" data-fp2="suave"        onclick="setFP2('suave',this)">üå∏</button>
      <button class="fp" data-fp2="seco"         onclick="setFP2('seco',this)">üçã</button>
      <button class="fp" data-fp2="fuerte"       onclick="setFP2('fuerte',this)">üî•</button>
      <button class="fp" data-fp2="extra-fuerte" onclick="setFP2('extra-fuerte',this)">üí•</button>
    </div>
  </div>
  <div id="fqGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px"></div>
</div>

</div><!-- /main -->

<!-- AGENDA MODAL -->
<div class="mo" id="agMo">
  <div class="mb">
    <div class="mh"><h3>Nuevo recordatorio</h3><button class="mc" onclick="closeAM()">‚úï</button></div>
    <div class="mbody">
      <div class="fgroup"><label class="fl">T√≠tulo</label><input id="agTit" placeholder="Ej: Llamar a proveedor Coca-Cola"/></div>
      <div class="fgroup"><label class="fl">Descripci√≥n</label><textarea id="agDes" placeholder="Detalles‚Ä¶" style="min-height:54px"></textarea></div>
      <div class="fg c2">
        <div class="fgroup"><label class="fl">Tipo</label>
          <select id="agTyp">
            <option value="proveedor">üìû Proveedor</option>
            <option value="pedido">üì¶ Pedido</option>
            <option value="tarea">‚úÖ Tarea</option>
            <option value="reunion">ü§ù Reuni√≥n</option>
            <option value="otro">üìå Otro</option>
          </select>
        </div>
        <div class="fgroup"><label class="fl">Contacto</label><input id="agCon" placeholder="Ej: Juan P√©rez"/></div>
        <div class="fgroup"><label class="fl">Fecha</label><input type="date" id="agDat"/></div>
        <div class="fgroup"><label class="fl">Hora</label><input type="time" id="agHor"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn bp" style="flex:1" onclick="saveAg()">Guardar</button>
        <button class="btn bs" onclick="closeAM()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANTI-ZOOM M√ìVIL (Xiaomi HyperOS) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
  const vp=document.querySelector('meta[name=viewport]');
  const orig=vp?vp.content:'';

  function disableZoom(){
    if(vp) vp.setAttribute('content',
      'width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no');
  }
  function enableZoom(){
    if(vp) vp.setAttribute('content', orig);
  }

  // On every input focus: lock viewport BEFORE browser zooms
  document.addEventListener('focusin',function(e){
    const t=e.target;
    if(t.tagName==='INPUT'||t.tagName==='SELECT'||t.tagName==='TEXTAREA'){
      disableZoom();
    }
  },true);

  document.addEventListener('focusout',function(e){
    const t=e.target;
    if(t.tagName==='INPUT'||t.tagName==='SELECT'||t.tagName==='TEXTAREA'){
      setTimeout(enableZoom, 300);
    }
  },true);
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const SU="https://hhfpaviwuuqcuhcsfwdj.supabase.co";
const SK="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoZnBhdml3dXVxY3VoY3Nmd2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzgwMDgsImV4cCI6MjA3ODg1NDAwOH0.LpccdL9cQqf4vZ5BPqRKnL2Mh5GiLd57pQKujcDHDLg";
const db=supabase.createClient(SU,SK,{
  auth:{
    storageKey:'mixly-auth',
    autoRefreshToken:true,
    persistSession:true,
    detectSessionInUrl:true,
    lock: async (name, acquireTimeout, fn) => {
      try { return await fn(); } catch(e) { return await fn(); }
    }
  }
});
let uid=null, cat=[], inv=[], recs=[], rems=[];

/* BOOT */
window.onload=async()=>{
  // Check password recovery from URL hash
  const hashP=new URLSearchParams(window.location.hash.substring(1));
  if(hashP.get('type')==='recovery'){
    document.getElementById('ls').style.display='none';
    document.getElementById('loginScreen').classList.add('show');
    lgsTab('reset');
    lgsShowAlert('‚úì Enlace v√°lido. Ingresa tu nueva contrase√±a','info');
    return;
  }
  const{data}=await db.auth.getSession();
  if(!data?.session){
    document.getElementById('ls').style.display='none';
    document.getElementById('loginScreen').classList.add('show');
    return;
  }
  await lgsInitApp(data.session.user);
};

db.auth.onAuthStateChange((event,session)=>{
  if(event==='PASSWORD_RECOVERY'){
    lgsTab('reset');
    lgsShowAlert('‚úì Enlace v√°lido. Ingresa tu nueva contrase√±a','info');
  } else if(event==='SIGNED_IN'&&session){
    lgsInitApp(session.user);
  }
});

async function lgsInitApp(u){
  uid=u.id;
  const m=u.user_metadata||{};
  document.getElementById('wname').textContent=m.bar_name||m.barName||'Mi Bar';
  document.getElementById('wemail').textContent=m.username||u.email;
  await lCat();
  await Promise.all([lInv(),lRecs(),lRems()]);
  initNav(); buildAc(); hStats();
  document.getElementById('ls').style.display='none';
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('sidebar').style.display='';
  document.getElementById('mainApp').style.display='';
  maybeStartOB();
}

/* NAV */
function initNav(){
  document.querySelectorAll('.ni').forEach(b=>{
    b.addEventListener('click',()=>{
      const p=b.dataset.p;
      if(p==='logout'){db.auth.signOut().then(()=>{
    uid=null;cat=[];inv=[];recs=[];rems=[];
    document.getElementById('sidebar').style.display='none';
    document.getElementById('mainApp').style.display='none';
    document.getElementById('loginScreen').classList.add('show');
    lgsTab('login');
  });return;}
      sp(p);
    });
  });
}
function sp(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+name)?.classList.add('active');
  document.querySelector(`.ni[data-p="${name}"]`)?.classList.add('active');
  if(name==='productos')renderP();
  if(name==='inventory')renderI();
  if(name==='recipes'){renderR();if(!rIC)addRI();}
  if(name==='agenda')renderAg();
  if(name==='buscador')initBuscador();
  if(name==='timers')renderTimers();
  if(name==='fichas')renderFichas();
}

/* HELPERS */
function ok(id,m){const e=document.getElementById(id);e.textContent='‚úì '+m;e.style.display='block';setTimeout(()=>e.style.display='none',3000)}
function er(id,m){const e=document.getElementById(id);e.textContent='‚ö† '+m;e.style.display='block';setTimeout(()=>e.style.display='none',5000)}
function cp(c){
  const styles={
    'Bebida':   'background:#E3F2FD;color:#1565C0;border-color:#90CAF9',
    'Cerveza':  'background:#FFF3E0;color:#E65100;border-color:#FFCC80',
    'Pisco':    'background:#FCE4EC;color:#880E4F;border-color:#F48FB1',
    'Ron':      'background:#F3E5F5;color:#6A1B9A;border-color:#CE93D8',
    'Tequila':  'background:#FFF8E1;color:#F57F17;border-color:#FFE082',
    'Vodka':    'background:#E8EAF6;color:#283593;border-color:#9FA8DA',
    'Whiskey':  'background:#EFEBE9;color:#4E342E;border-color:#BCAAA4',
    'Vino':     'background:#F3E5F5;color:#7B1FA2;border-color:#BA68C8',
    'Gin':      'background:#E0F7FA;color:#00696F;border-color:#80DEEA',
    'Licor':    'background:#EDE7F6;color:#4527A0;border-color:#B39DDB',
    'Fruta':    'background:#E8F5E9;color:#2E7D32;border-color:#A5D6A7',
    'Insumo':   'background:#F1F8E9;color:#558B2F;border-color:#C5E1A5',
    'Base':     'background:#ECEFF1;color:#37474F;border-color:#B0BEC5',
  };
  const s=styles[c]||'background:#F5F5F5;color:#616161;border-color:#E0E0E0';
  return`<span style="display:inline-block;padding:2px 10px;border-radius:20px;font-size:.68rem;font-weight:700;letter-spacing:.5px;border:1px solid;${s}">${c}</span>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRODUCTOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let pEId=null, pCatFilt='all';

async function lCat(){
  const{data}=await db.from('products').select('*').eq('user_id',uid).order('name');
  // cat includes all products; inv filters out skip_inventory ones
  cat=data||[];
}

function tPF(s){
  document.getElementById('pForm').classList.toggle('show',s);
  if(!s){pEId=null;clrP();document.getElementById('pFT').textContent='Nuevo producto';}
}

function clrP(){
  ['pN','pQ','pP','pProv','pMinSt'].forEach(id=>document.getElementById(id).value='');document.getElementById('pSkipInv').checked=false;
  document.getElementById('pC').value='';
  document.getElementById('pU').value='';
  document.getElementById('pHint').textContent='Precio / unidad: ‚Äî';
}

function upPH(){
  const q=parseFloat(document.getElementById('pQ').value);
  const p=parseFloat(document.getElementById('pP').value);
  const u=document.getElementById('pU').value;
  if(q>0&&p>=0&&u){
    const ppu=p/q;
    document.getElementById('pHint').textContent=`Precio / ${u}: $${ppu.toFixed(2)} ‚Äî Total ${q} ${u} por $${p.toLocaleString('es-CL')}`;
  } else {
    document.getElementById('pHint').textContent='Precio / unidad: ‚Äî';
  }
}

async function saveP(){
  const name=document.getElementById('pN').value.trim();
  const cat2=document.getElementById('pC').value;
  const q=parseFloat(document.getElementById('pQ').value);
  const p=parseFloat(document.getElementById('pP').value);
  const u=document.getElementById('pU').value;
  const prov=document.getElementById('pProv').value.trim();
  const minSt=parseFloat(document.getElementById('pMinSt').value)||0;

  if(!name||!cat2||!q||isNaN(p)||!u){er('p-er','Completa: nombre, categor√≠a, cantidad, precio y unidad');return;}

  const skipInv=document.getElementById('pSkipInv')?.checked||false;
  const pl={
    user_id:uid,
    name, category:cat2, unit_type:u,
    cantidad_total:q, precio_total:p,
    price_per_ml:p/q,
    provider:prov||null,
    min_stock:minSt,
    skip_inventory:skipInv
  };

  const{error}=pEId
    ?await db.from('products').update(pl).eq('id',pEId)
    :await db.from('products').insert([pl]);

  if(error){er('p-er',error.message);return;}
  ok('p-ok',pEId?'Producto actualizado':'Producto agregado');
  pEId=null;tPF(false);
  await lCat(); await lInv(); // refresh both
  renderP();renderI();hStats();
}

function renderP(){
  const tb=document.getElementById('pTb');
  const srch=(document.getElementById('pSearch')?.value||'').toLowerCase();
  let list=[...cat];
  if(pCatFilt!=='all') list=list.filter(p=>p.category===pCatFilt);
  if(srch) list=list.filter(p=>p.name.toLowerCase().includes(srch)||(p.provider||'').toLowerCase().includes(srch));
  list.sort((a,b)=>(a.category||'').localeCompare(b.category||'','es')||(a.provider||'').localeCompare(b.provider||'','es')||(a.name||'').localeCompare(b.name||'','es'));

  document.getElementById('pCount').textContent=`${list.length} producto${list.length!==1?'s':''}`;

  if(!list.length){
    tb.innerHTML='<tr><td colspan="9"><div class="empty"><div class="ei">üì¶</div><p>No hay productos</p></div></td></tr>';
    return;
  }
  tb.innerHTML=list.map(p=>{
    const ppu=Number(p.price_per_ml);
    const minSt=p.min_stock||0;
    const invItem=inv.find(i=>i.product_id===p.id);
    const totalStock=invItem?(invItem.stock_barra||0)+(invItem.stock_bodega||0):null;
    const lowStock=totalStock!==null&&totalStock<=minSt;
    return`<tr>
      <td><strong>${p.name}</strong></td>
      <td>${cp(p.category)}</td>
      <td style="color:var(--t3);font-size:.78rem">${p.provider||'‚Äî'}</td>
      <td class="c">${Number(p.cantidad_total).toLocaleString('es-CL')}</td>
      <td class="c"><span class="pill pm">${p.unit_type}</span></td>
      <td class="c">$${Number(p.precio_total).toLocaleString('es-CL')}</td>
      <td class="c" style="color:var(--a2);font-weight:700">$${ppu.toFixed(2)}/${p.unit_type}</td>
      <td class="c">
        <span class="${minSt>0?(lowStock?'pill pw':'pill po'):'pill pm'}">${minSt>0?minSt:'‚Äî'}</span>
        ${totalStock!==null?`<div class="sub">stock: ${totalStock.toFixed(2)}</div>`:''}
      </td>
      <td class="c" style="display:flex;gap:5px;justify-content:center">
        <button class="btn bs sm" onclick="editP(${p.id})">Editar</button>
        <button class="btn bd sm" onclick="delP(${p.id})">Eliminar</button>
      </td>
    </tr>`;
  }).join('');
}

// Cat filter tabs
document.getElementById('pCatFilter').addEventListener('click',e=>{
  const btn=e.target.closest('[data-cat]');
  if(!btn)return;
  pCatFilt=btn.dataset.cat;
  document.querySelectorAll('#pCatFilter .lt').forEach(b=>b.classList.toggle('active',b.dataset.cat===pCatFilt));
  renderP();
});

window.editP=(id)=>{
  const p=cat.find(x=>x.id===id);if(!p)return;
  pEId=id;
  document.getElementById('pN').value=p.name;
  document.getElementById('pC').value=p.category;
  document.getElementById('pQ').value=p.cantidad_total;
  document.getElementById('pP').value=p.precio_total;
  document.getElementById('pU').value=p.unit_type;
  document.getElementById('pProv').value=p.provider||'';
  document.getElementById('pMinSt').value=p.min_stock||'';
  document.getElementById('pSkipInv').checked=p.skip_inventory||false;
  upPH();
  document.getElementById('pFT').textContent='Editar producto';
  tPF(true);
  document.getElementById('pForm').scrollIntoView({behavior:'smooth',block:'start'});
};

window.delP=async(id)=>{
  if(!confirm('¬øEliminar producto del cat√°logo?\nEsto NO elimina el stock en inventario.'))return;
  await db.from('products').delete().eq('id',id).eq('user_id',uid);
  await lCat();await lInv();renderP();renderI();hStats();
  ok('p-ok','Producto eliminado');
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVENTARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Inventory is now a pure stock view ‚Äî all product data comes from `cat` (products table)
// inventory table only stores: product_id, stock_barra, stock_bodega (+ user_id)
let iLoc='barra',iHist=[];

async function lInv(){
  // cat DEBE estar cargado antes de llamar a lInv
  if(!cat.length) await lCat();

  const{data,error}=await db.from('inventory')
    .select('id,product_id,stock_barra,stock_bodega,pedido_real')
    .eq('user_id',uid);

  if(error){console.error('lInv error:',error);inv=[];return;}

  const rows=data||[];
  // Exclude products marked as skip_inventory
  const invCat=cat.filter(p=>!p.skip_inventory);
  const catIds=new Set(invCat.map(p=>p.id));

  // Filtrar solo filas validas (sin borrar nada de la DB para evitar errores RLS)
  const valid=rows.filter(r=>r.product_id&&catIds.has(r.product_id));

  const merge=r=>{
    const p=cat.find(x=>x.id===r.product_id);
    return{...r,
      name:        p?.name||'Sin nombre',
      category:    p?.category||'‚Äî',
      unit:        p?.unit_type||'‚Äî',
      provider:    p?.provider||'‚Äî',
      min_stock:   Number(p?.min_stock)||0,
      price_per_ml:Number(p?.price_per_ml)||0,
      stock_barra: Number(r.stock_barra)||0,
      stock_bodega:Number(r.stock_bodega)||0,
      pedido_real: Number(r.pedido_real)||0,
    };
  };

  inv=valid.map(merge).sort((a,b)=>(a.category||'').localeCompare(b.category||'','es')||(a.provider||'').localeCompare(b.provider||'','es')||(a.name||'').localeCompare(b.name||'','es'));

  // Auto-crear filas de inventario para productos que no las tienen aun
  const existIds=new Set(valid.map(i=>i.product_id));
  const missing=cat.filter(p=>!existIds.has(p.id));
  if(missing.length){
    console.log('Creando filas de inventario para',missing.length,'productos nuevos...');
    try{
      const{data:ins,error:insErr}=await db.from('inventory')
        .insert(missing.map(p=>({user_id:uid,product_id:p.id,stock_barra:0,stock_bodega:0})))
        .select('id,product_id,stock_barra,stock_bodega,pedido_real');
      if(insErr){console.error('Error insertando filas inventario:',insErr);}
      else if(ins?.length){
        inv=[...inv,...ins.map(merge)]
          .sort((a,b)=>(a.category||'').localeCompare(b.category||'','es')||(a.provider||'').localeCompare(b.provider||'','es')||(a.name||'').localeCompare(b.name||'','es'));
        console.log('Inventario actualizado, total filas:',inv.length);
      }
    }catch(e){console.error('Insert inventory error:',e);}
  }
}

function pedBg(total,min){
  // Retorna objeto {bg, color} seg√∫n nivel de stock
  if(!min||min===0) return null;
  if(total===0)           return {bg:'#FFEBEE',col:'#C62828'};
  if(total < min/2)       return {bg:'#FFF3E0',col:'#E65100'};
  if(total < min)         return {bg:'#FFFDE7',col:'#F9A825'};
  return                         {bg:'#E8F5E9',col:'#2E7D32'};
}

function renderI(){
  iStats();
  const tb=document.getElementById('iTb');
  if(!inv.length){
    tb.innerHTML='<tr><td colspan="7"><div class="empty"><div class="ei">üì¶</div><p>No hay productos en el cat√°logo.<br><a href="javascript:sp(\'productos\')" style="color:var(--a2)">Agrega productos primero ‚Üí</a></p></div></td></tr>';
    return;
  }
  tb.innerHTML=inv.map(item=>{
    const s=iLoc==='barra'?item.stock_barra:item.stock_bodega;
    const total=item.stock_barra+item.stock_bodega;
    const min=item.min_stock||0;
    const zero=total===0;
    const bajo=min>0&&total<min;
    const pb=pedBg(total,min);
    const pedVal=item.pedido_real||0;
    const inputBg=pb?pb.bg:'transparent';
    const inputCol=pb?pb.col:'var(--t2)';
    return`<tr>
      <td><strong>${item.name}</strong></td>
      <td>${cp(item.category)}</td>
      <td style="color:var(--t3);font-size:.78rem">${item.provider||'‚Äî'}</td>
      <td class="c">
        <input type="number" class="ni2${zero?' nlow':bajo?' nlow':''}" value="${s}" min="0" step="0.01"
          inputmode="decimal" enterkeyhint="next"
          onfocus="invFocus(this)"
          onkeydown="invKey(event,this)"
          onkeyup="invKey(event,this)"
          onchange="uIS('${item.id}',this.value)"
          ontouchend="invTouchEnd(event,this)">
        <div class="sub" style="${zero?'color:var(--danger);font-weight:600':''}">Total: ${total.toFixed(2)}</div>
      </td>
      <td class="c"><span style="font-size:.72rem;color:var(--t3)">${item.unit}</span></td>
      <td class="c" style="color:var(--t3);font-size:.8rem">${min>0?min:'‚Äî'}</td>
      <td class="c">
        <input type="number" class="ni2" value="${pedVal||''}" min="0" step="1" placeholder="0"
          style="background:${inputBg};color:${inputCol};font-weight:${pb?'700':'400'};width:70px;text-align:center"
          inputmode="numeric" enterkeyhint="next"
          onfocus="invFocus(this)"
          onkeydown="invKey(event,this)"
          onkeyup="invKey(event,this)"
          onchange="uIPed('${item.id}',this.value)"
          ontouchend="invTouchEnd(event,this)">
        ${min>0&&total<min?`<div class="sub" style="color:${inputCol}">sug: ${Math.ceil(min-total)}</div>`:''}
      </td>
    </tr>`;
  }).join('');
}

window.uIS=async(id,val)=>{
  const v=parseFloat(val);if(isNaN(v)||v<0)return;
  const item=inv.find(i=>i.id==id);if(!item)return;
  const old=iLoc==='barra'?item.stock_barra:item.stock_bodega;
  await db.from('inventory').update(iLoc==='barra'?{stock_barra:v}:{stock_bodega:v}).eq('id',id);
  if(iLoc==='barra')item.stock_barra=v;else item.stock_bodega=v;
  iHist.push({id,loc:iLoc,old});
  document.getElementById('iUndo').disabled=false;
  iStats();ok('i-ok','Stock actualizado');
};

window.uIPed=async(id,val)=>{
  const v=parseInt(val)||0;
  await db.from('inventory').update({pedido_real:v}).eq('id',id);
  const item=inv.find(i=>i.id==id);
  if(item)item.pedido_real=v;
  // Refresh just that cell's color without full re-render
  renderI();
};

async function undoI(){
  if(!iHist.length)return;
  const l=iHist.pop();
  await db.from('inventory').update(l.loc==='barra'?{stock_barra:l.old}:{stock_bodega:l.old}).eq('id',l.id);
  const item=inv.find(i=>i.id==l.id);
  if(item){if(l.loc==='barra')item.stock_barra=l.old;else item.stock_bodega=l.old;}
  renderI();
  document.getElementById('iUndo').disabled=iHist.length===0;
  ok('i-ok','Acci√≥n deshecha');
}

async function resetI(){
  if(!confirm('¬øVaciar TODO el stock a 0?\nEsto no elimina los productos del cat√°logo.'))return;
  await db.from('inventory').update({stock_barra:0,stock_bodega:0}).eq('user_id',uid);
  inv.forEach(i=>{i.stock_barra=0;i.stock_bodega=0;});
  renderI();ok('i-ok','Stock vaciado');
}

function iStats(){
  const low=inv.filter(i=>(i.stock_barra+i.stock_bodega)<=(i.min_stock||0)&&(i.min_stock||0)>0).length;
  const zero=inv.filter(i=>(i.stock_barra+i.stock_bodega)===0).length;
  const ped=inv.filter(i=>(i.stock_barra+i.stock_bodega)<(i.min_stock||0)&&(i.min_stock||0)>0).length;
  document.getElementById('iT').textContent=inv.length;
  document.getElementById('iL').textContent=low;
  document.getElementById('iZ').textContent=zero;
  document.getElementById('iP').textContent=ped;
  const warn=document.getElementById('iLowWarn');
  if(warn)warn.style.display=low>0?'block':'none';
}

document.querySelectorAll('.lt').forEach(t=>{
  t.addEventListener('click',()=>{
    iLoc=t.dataset.loc;
    document.querySelectorAll('.lt').forEach(x=>x.classList.toggle('active',x.dataset.loc===iLoc));
    document.getElementById('iLL').textContent=iLoc==='barra'?'Barra':'Bodega';
    document.getElementById('iLB').textContent=iLoc==='barra'?'BARRA':'BODEGA';
    renderI();
  });
});

async function expInv(){
  if(!inv.length)return;
  const wb=new ExcelJS.Workbook();
  wb.creator='Mixly';
  const ws=wb.addWorksheet('Inventario',{pageSetup:{fitToPage:true,fitToWidth:1}});

  const catOrder=['Bebida','Cerveza','Pisco','Ron','Tequila','Vodka','Whiskey','Vino','Gin','Licor','Fruta','Insumo','Base'];

  // Colores representativos por categor√≠a
  const catBg={
    Bebida:'FF1565C0',  // azul agua
    Cerveza:'FFE65100', // naranja ambar
    Pisco:'FF6A1B9A',   // morado
    Ron:'FF4E342E',     // caf√© oscuro
    Tequila:'FFF57F17', // amarillo dorado
    Vodka:'FF283593',   // azul √≠ndigo
    Whiskey:'FF5D4037', // caf√© c√°lido
    Vino:'FF7B1FA2',    // vino/borgo√±a
    Gin:'FF00696F',     // verde teal
    Licor:'FF4527A0',   // violeta
    Fruta:'FF2E7D32',   // verde natural
    Insumo:'FF37474F',  // gris azulado
    Base:'FF455A64',    // gris pizarra
  };

  ws.columns=[
    {key:'prod', width:32},
    {key:'prov', width:22},
    {key:'stk',  width:14},
    {key:'min',  width:14},
    {key:'ped',  width:18},
  ];

  // T√≠tulo principal
  const titleRow=ws.addRow(['INVENTARIO MIXLY','','','','']);
  ws.mergeCells('A1:E1');
  titleRow.height=28;
  const tc=titleRow.getCell('A');
  tc.value='INVENTARIO MIXLY  ¬∑  '+new Date().toLocaleDateString('es-CL',{day:'2-digit',month:'long',year:'numeric'}).toUpperCase();
  tc.font={bold:true,size:13,color:{argb:'FF0A1628'},name:'Calibri'};
  tc.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFEDF3FA'}};
  tc.alignment={horizontal:'left',vertical:'middle'};
  tc.border={bottom:{style:'medium',color:{argb:'FF00C2FF'}}};
  ws.addRow([]); // spacer

  // Agrupar
  const grupos={};
  catOrder.forEach(c=>{grupos[c]=[];});
  inv.forEach(item=>{const c=item.category||'Insumo';if(!grupos[c])grupos[c]=[];grupos[c].push(item);});

  const thin={style:'thin',color:{argb:'FFE8E8E8'}};
  const none={style:'thin',color:{argb:'FFFFFFFF'}};

  catOrder.forEach(cat=>{
    const items=grupos[cat];
    if(!items||!items.length)return;
    const bg=catBg[cat]||'FF37474F';

    // Header de secci√≥n
    const hRow=ws.addRow([cat.toUpperCase(),'','','','']);
    ws.mergeCells('A'+hRow.number+':E'+hRow.number);
    hRow.height=20;
    const hc=hRow.getCell('A');
    hc.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
    hc.font={bold:true,size:10,color:{argb:'FFFFFFFF'},name:'Calibri'};
    hc.alignment={horizontal:'left',vertical:'middle',indent:1};

    // Sub-header columnas
    const shRow=ws.addRow(['Producto','Proveedor','Stock','M√≠nimo','Pedido Sugerido']);
    shRow.height=16;
    ['A','B','C','D','E'].forEach((col,i)=>{
      const c=shRow.getCell(col);
      c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFF4F8FD'}};
      c.font={bold:true,size:9,color:{argb:'FF3A5A80'},name:'Calibri'};
      c.alignment={horizontal:i===0?'left':'center',vertical:'middle'};
      c.border={bottom:{style:'thin',color:{argb:bg}}};
    });

    // Filas de datos
    items.forEach((item,i)=>{
      const total=item.stock_barra+item.stock_bodega;
      const min=item.min_stock||0;
      const unit=item.unit||'';
      const zero=total===0;
      const low=min>0&&total<min/2;
      const mid=min>0&&total>=min/2&&total<min;
      // pedido_real: lo que el usuario ingres√≥ en la app
      const ped=item.pedido_real||0;

      const fmtNum=v=>v%1===0?v+' '+unit:v.toFixed(2)+' '+unit;
      const row=ws.addRow([
        item.name,
        item.provider||'',
        total>0?fmtNum(total):'0 '+unit,
        min>0?fmtNum(min):'‚Äî',
        '' // pedido ‚Äî se setea abajo
      ]);
      row.height=17;

      const rowBg=i%2===0?'FFFFFFFF':'FFFAFBFD';
      ['A','B','C','D','E'].forEach((col,ci)=>{
        const c=row.getCell(col);
        c.fill={type:'pattern',pattern:'solid',fgColor:{argb:rowBg}};
        c.font={size:10,name:'Calibri',color:{argb:'FF0A1628'}};
        c.alignment={horizontal:ci===0?'left':'center',vertical:'middle'};
        c.border={bottom:{style:'thin',color:{argb:'FFF0F0F0'}}};
      });

      // Columna "A pedir" ‚Äî color seg√∫n stock, valor = lo que ingres√≥ el usuario
      const pedCell=row.getCell('E');
      if(ped===0){
        // Sin pedido ‚Üí OK verde
        pedCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE8F5E9'}};
        pedCell.font={size:10,color:{argb:'FF2E7D32'},name:'Calibri'};
        pedCell.value='OK';
      } else {
        // Tiene pedido ‚Üí color seg√∫n nivel de stock actual
        pedCell.value=ped+' '+unit;
        if(zero){
          pedCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFEBEE'}};
          pedCell.font={bold:true,size:10,color:{argb:'FFC62828'},name:'Calibri'};
        } else if(low){
          pedCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFF3E0'}};
          pedCell.font={bold:true,size:10,color:{argb:'FFE65100'},name:'Calibri'};
        } else if(mid){
          pedCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFFDE7'}};
          pedCell.font={bold:true,size:10,color:{argb:'FFF9A825'},name:'Calibri'};
        } else {
          // Tiene pedido pero stock est√° OK ‚Äî amarillo suave
          pedCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFFFFDE7'}};
          pedCell.font={bold:true,size:10,color:{argb:'FFF9A825'},name:'Calibri'};
        }
      }
    });

    ws.addRow([]); // espacio entre secciones
  });

  const buf=await wb.xlsx.writeBuffer();
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  a.download='Inventario_Mixly_'+new Date().toISOString().split('T')[0]+'.xlsx';
  a.click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RECETARIO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let rIngs=[],rProf=null,rFilt='all',rIC=0,rColor='#00C2FF';
async function lRecs(){const{data}=await db.from('recipes').select('*').eq('user_id',uid).order('created_at',{ascending:false});recs=data||[];}
window.addRI=function(){rIC++;const id=Date.now();
  const c=document.getElementById('rIC'),d=document.createElement('div');
  d.className='ingrow';d.id='ri-'+id;
  d.innerHTML=`
    <div class="ing-ac">
      <input id="rn-${id}" placeholder="Producto o ingrediente libre‚Ä¶" autocomplete="off"
        style="font-size:.78rem" oninput="acRI(${id})" onblur="acHide(${id})" onkeydown="acKey(event,${id})"/>
      <div class="ing-ac-list" id="ac-${id}"></div>
    </div>
    <input type="number" placeholder="Cant." min="0" step="0.01" id="rq-${id}"
      oninput="onRI(${id})"
      onkeydown="if(event.key==='Enter'){event.preventDefault();acJumpNext(${id});}"
      style="text-align:center"/>
    <select id="ru-${id}" onchange="onRI(${id})" style="font-size:.75rem;padding:8px 6px">
      <option value="ml">ml</option>
      <option value="oz">oz</option>
      <option value="cl">cl</option>
      <option value="lt">lt</option>
      <option value="gr">gr</option>
      <option value="kg">kg</option>
      <option value="un">un</option>
      <option value="cdta">cdta</option>
      <option value="cda">cda</option>
      <option value="taza">taza</option>
      <option value="pzca">pzca</option>
    </select>
    <div class="icd" id="rc-${id}">‚Äî</div>
    <button class="brm" onclick="rmRI(${id})">‚úï</button>`;
  c.appendChild(d);
  rIngs.push({id,pid:null,name:'',q:0,unit:'ml',ppm:0});
  // Focus the new input
  setTimeout(()=>document.getElementById('rn-'+id)?.focus(),50);
};
window.onRI=function(id){
  const q=parseFloat(document.getElementById('rq-'+id)?.value)||0;
  const unit=document.getElementById('ru-'+id)?.value||'ml';
  const ing=rIngs.find(i=>i.id===id);
  if(!ing)return;
  const toMl={ml:1,oz:29.5735,cl:10,lt:1000,gr:1,kg:1000,un:1,cdta:5,cda:15,taza:240,pzca:0.5};
  const factor=toMl[unit]||1;
  ing.q=q;ing.unit=unit;
  const cost=ing.ppm*(q*factor);
  document.getElementById('rc-'+id).textContent=(cost>0&&ing.pid)?`$${cost.toFixed(0)}`:'‚Äî';
  updRC();};
window.rmRI=function(id){document.getElementById('ri-'+id)?.remove();rIngs=rIngs.filter(i=>i.id!==id);rIC--;updRC();};
function updRC(){const t=rIngs.reduce((s,i)=>s+(i.ppm*i.q),0),h=rIngs.some(i=>i.pid&&i.q>0);document.getElementById('rCP').style.display=h?'flex':'none';document.getElementById('rCT').textContent=`$${t.toFixed(2)}`;}
window.selP=function(p){document.querySelectorAll('.po2').forEach(e=>e.classList.remove('sel'));document.querySelector(`.po2[data-p="${p}"]`).classList.add('sel');rProf=p;};
window.saveR=async function(){const name=document.getElementById('rN').value.trim();if(!name){alert('Escribe un nombre');return;}if(!rProf){alert('Selecciona un perfil');return;}const v=rIngs.filter(i=>i.name&&i.q>0);if(!v.length){alert('Agrega al menos un ingrediente con cantidad');return;}const t=v.reduce((s,i)=>s+(i.ppm*i.q),0);
  await db.from('recipes').insert([{user_id:uid,name,description:document.getElementById('rD').value,preparation:document.getElementById('rPr').value,profile:rProf,color:rColor||'#00C2FF',ingredients:v.map(i=>{const toMl2={ml:1,oz:29.5735,cl:10,lt:1000,gr:1,kg:1000,un:1,cdta:5,cda:15,taza:240,pzca:0.5};const f=toMl2[i.unit]||1;return{product_id:i.pid,name:i.name,quantity:i.q,unit:i.unit,price_per_ml:i.ppm,line_cost:+(i.ppm*i.q*f).toFixed(2)}}),total_cost:+t.toFixed(2)}]);
  document.getElementById('rN').value=document.getElementById('rD').value=document.getElementById('rPr').value='';document.getElementById('rIC').innerHTML='';rIngs=[];rProf=null;rColor='#00C2FF';rIC=0;document.querySelectorAll('.po2').forEach(e=>e.classList.remove('sel'));document.querySelectorAll('.rcol-btn').forEach((b,i)=>{b.style.border=i===0?'3px solid var(--accent)':'2px solid transparent';});document.getElementById('rCP').style.display='none';addRI();await lRecs();renderR();hStats();};
function renderR(){const c=document.getElementById('rList'),s=(document.getElementById('rSrch')?.value||'').toLowerCase();let l=recs;if(rFilt!=='all')l=l.filter(r=>r.profile===rFilt);if(s)l=l.filter(r=>r.name.toLowerCase().includes(s)||r.description?.toLowerCase().includes(s));
  if(!l.length){c.innerHTML='<div class="empty"><div class="ei">üçπ</div><p>No se encontraron recetas</p></div>';return;}
  const pi={dulce:'üç¨',suave:'üå∏',seco:'üçã',fuerte:'üî•','extra-fuerte':'üí•'};
  c.innerHTML=l.map(r=>`<div class="rcard">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
      <div><div class="rname">${r.name}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:3px">
          <span class="pill pa">${pi[r.profile]||''} ${r.profile}</span>
          ${r.total_cost?`<span class="pill po">$${Number(r.total_cost).toFixed(2)}</span>`:''}
        </div>
      </div>
      <button class="btn bd sm" onclick="delR(${r.id})">Eliminar</button>
    </div>
    ${r.description?`<div style="font-size:.75rem;color:var(--t3);margin-bottom:8px">${r.description}</div>`:''}
    <div style="font-size:.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:5px">Ingredientes</div>
    ${(r.ingredients||[]).map(i=>`<div class="rrow"><span>${i.name} ‚Äî ${i.quantity} ${i.unit}</span><span class="rcost">${i.line_cost?'$'+Number(i.line_cost).toFixed(2):''}</span></div>`).join('')}
    ${r.preparation?`<div style="margin-top:9px;padding-top:9px;border-top:1px solid var(--b2);font-size:.75rem;color:var(--t2)">${r.preparation}</div>`:''}
  </div>`).join('');}
window.delR=async(id)=>{if(!confirm('¬øEliminar receta?'))return;await db.from('recipes').delete().eq('id',id).eq('user_id',uid);await lRecs();renderR();hStats();};
window.setRF=function(f,el){rFilt=f;document.querySelectorAll('[data-f]').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderR();};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COSTEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let cIngs=[];
function onCcat(){const ca=document.getElementById('cCat').value,sel=document.getElementById('cProd');sel.innerHTML='<option value="">Producto‚Ä¶</option>';cat.filter(p=>p.category===ca).forEach(p=>{sel.innerHTML+=`<option value="${p.id}">${p.name} ‚Äî $${Number(p.price_per_ml).toFixed(2)}/ml</option>`;});}
function addCI(){const pid=document.getElementById('cProd').value,q=parseFloat(document.getElementById('cQty').value);if(!pid||isNaN(q)||q<=0){alert('Producto y cantidad v√°lida');return;}const p=cat.find(x=>x.id==pid);if(!p)return;cIngs.push({name:p.name,q,ppm:Number(p.price_per_ml)});document.getElementById('cQty').value='';rcalc();}
function rcalc(){let base=0,h='';cIngs.forEach(i=>{const s=i.ppm*i.q;base+=s;h+=`<div class="iline"><div><div class="in">${i.name}</div><div class="is">${i.q} ml √ó $${i.ppm.toFixed(2)}/ml</div></div><div class="ic2">$${s.toFixed(0)}</div></div>`;});
  document.getElementById('cDesglose').innerHTML=h||'<div class="empty"><div class="ei">üßæ</div><p>Agrega ingredientes</p></div>';document.getElementById('cCR').textContent='$'+base.toFixed(0);
  const m=parseFloat(document.getElementById('cMar').value)||1,op=base*.1,conM=(base+op)*m,iva=conM*.19,fin=conM+iva;
  document.getElementById('cFB').textContent='$'+base.toFixed(0);document.getElementById('cFO').textContent='$'+op.toFixed(0);document.getElementById('cFM').textContent='$'+conM.toFixed(0);document.getElementById('cFI').textContent='$'+iva.toFixed(0);document.getElementById('cFF').textContent='$'+fin.toFixed(0);document.getElementById('cPF').textContent='$'+fin.toFixed(0);}
function expCosteo(){if(!cIngs.length){alert('Agrega ingredientes');return;}const nom=document.getElementById('cNom').value||'Coctel',m=document.getElementById('cMar').value,d=[['Nombre',nom],['Margen','x'+m],[],['Ingrediente','Cantidad','Costo/ml','Subtotal']];cIngs.forEach(i=>d.push([i.name,i.q,i.ppm.toFixed(2),(i.ppm*i.q).toFixed(0)]));d.push([],['Precio final',document.getElementById('cFF').textContent.replace('$','')]);const ws=XLSX.utils.aoa_to_sheet(d),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Costeo');XLSX.writeFile(wb,nom+'_costeo.xlsx');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AGENDA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let agTab='pending';
async function lRems(){const{data}=await db.from('reminders').select('*').eq('user_id',uid).order('date',{ascending:true});rems=data||[];updBdot();}
function updBdot(){const t=new Date();t.setHours(0,0,0,0);const u=rems.filter(r=>{if(r.completed)return false;const d=new Date(r.date+'T00:00:00');d.setHours(0,0,0,0);return d<=t;});document.getElementById('bdot').style.display=u.length?'block':'none';}
function renderAg(){
  const today=new Date();today.setHours(0,0,0,0);const week=new Date(today);week.setDate(week.getDate()+7);
  const urg=rems.filter(r=>{if(r.completed)return false;const d=new Date(r.date+'T00:00:00');d.setHours(0,0,0,0);return d<=today;});
  const ua=document.getElementById('uAlerts');
  if(urg.length){ua.style.display='grid';ua.innerHTML=urg.map(r=>{const d=new Date(r.date+'T00:00:00');d.setHours(0,0,0,0);const ip=d<today;return`<div class="ualert${ip?'':' w'}"><div class="uat">${ip?'¬°URGENTE!':'HOY'}</div><div class="uad">${giT(r.type)} ${r.title}</div>${r.contact?`<div style="font-size:.7rem;color:var(--t3);margin-top:3px">üë§ ${r.contact}</div>`:''}</div>`;}).join('');}
  else ua.style.display='none';
  let fl=rems.filter(r=>{const d=new Date(r.date+'T00:00:00');d.setHours(0,0,0,0);if(agTab==='completed')return r.completed;if(r.completed)return false;if(agTab==='pending')return true;if(agTab==='today')return d.getTime()===today.getTime();if(agTab==='week')return d>=today&&d<=week;return true;});
  const c=document.getElementById('agList');
  if(!fl.length){c.innerHTML='<div class="empty"><div class="ei">üìÖ</div><p>No hay recordatorios</p></div>';return;}
  c.innerHTML=fl.map(r=>{const d=new Date(r.date+'T00:00:00'),fmt=d.toLocaleDateString('es-CL',{weekday:'short',day:'numeric',month:'short'});return`<div class="acard"><div class="ach" onclick="togR(${r.id})">${r.completed?'‚úÖ':'‚≠ï'}</div><div style="flex:1"><div class="at" style="${r.completed?'text-decoration:line-through;color:var(--t3)':''}">${r.title}</div><div class="am"><div class="ami">${giT(r.type)} ${giL(r.type)}</div><div class="ami">üìÖ ${fmt} ${r.time||''}</div>${r.contact?`<div class="ami">üë§ ${r.contact}</div>`:''}</div>${r.description?`<div style="font-size:.72rem;color:var(--t3);margin-top:3px">${r.description}</div>`:''}</div><button class="btn bd sm" onclick="delAg(${r.id})">üóë</button></div>`;}).join('');}
window.togR=async(id)=>{const r=rems.find(x=>x.id===id);if(!r)return;await db.from('reminders').update({completed:!r.completed}).eq('id',id);await lRems();renderAg();};
window.delAg=async(id)=>{if(!confirm('¬øEliminar?'))return;await db.from('reminders').delete().eq('id',id);await lRems();renderAg();};
function openAM(){document.getElementById('agDat').min=new Date().toISOString().split('T')[0];document.getElementById('agMo').classList.add('show');}
function closeAM(){document.getElementById('agMo').classList.remove('show');}
window.saveAg=async()=>{const t=document.getElementById('agTit').value.trim(),d=document.getElementById('agDat').value;if(!t||!d){alert('Completa t√≠tulo y fecha');return;}
  await db.from('reminders').insert([{user_id:uid,title:t,description:document.getElementById('agDes').value,type:document.getElementById('agTyp').value,date:d,time:document.getElementById('agHor').value,contact:document.getElementById('agCon').value,completed:false}]);
  closeAM();['agTit','agDes','agCon','agHor'].forEach(id=>document.getElementById(id).value='');await lRems();renderAg();};
function setAT(t,el){agTab=t;document.querySelectorAll('[data-ag]').forEach(b=>b.classList.remove('active'));el.classList.add('active');renderAg();}
function giT(t){return{proveedor:'üìû',pedido:'üì¶',tarea:'‚úÖ',reunion:'ü§ù',otro:'üìå'}[t]||'üìå';}
function giL(t){return{proveedor:'Proveedor',pedido:'Pedido',tarea:'Tarea',reunion:'Reuni√≥n',otro:'Otro'}[t]||t;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACADEMIA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ACD={
  tecnicas:[
    {i:'ü•É',t:'Stir',d:'Mezcla suave en vaso mezclador con hielo. Para c√≥cteles espirituosos y transparentes. 30‚Äì40 vueltas.'},
    {i:'üç∏',t:'Shake',d:'Shaker con hielo 10‚Äì15 seg. Para jugos, cremas o huevo. Genera diluci√≥n y textura.'},
    {i:'üåø',t:'Muddle',d:'Machacar suavemente frutas, hierbas o az√∫car para liberar aromas y jugos.'},
    {i:'üèóÔ∏è',t:'Build',d:'Preparar directo en el vaso. Ingredientes en capas del m√°s denso al m√°s ligero.'},
    {i:'üåÄ',t:'Blend',d:'Ingredientes con hielo en licuadora. Para frozen drinks y smoothies de barra.'},
    {i:'üìè',t:'Float',d:'Verter lentamente el √∫ltimo ingrediente sobre el dorso de la cuchara para que flote.'},
    {i:'üßÇ',t:'Rim',d:'Pasar c√≠trico por el borde y presionar en sal, az√∫car o especias para escarchar.'},
    {i:'üî•',t:'Dry Shake',d:'Agitar sin hielo para emulsionar clara de huevo. Luego volver a agitar con hielo.'},
  ],
  recetas:[
    {i:'üçπ',t:'Mojito',d:'50ml Ron ¬∑ 30ml Lima ¬∑ 10ml Az√∫car ¬∑ Menta ¬∑ Soda\nT√©cnica: Muddle + Build'},
    {i:'üç∏',t:'Negroni',d:'30ml Gin ¬∑ 30ml Campari ¬∑ 30ml Vermut rojo\nT√©cnica: Stir'},
    {i:'ü•É',t:'Old Fashioned',d:'60ml Bourbon ¬∑ 10ml Jarabe ¬∑ 2 dash Angostura\nT√©cnica: Build + Stir'},
    {i:'üçã',t:'Daiquiri',d:'50ml Ron blanco ¬∑ 25ml Lima ¬∑ 15ml Jarabe\nT√©cnica: Shake'},
    {i:'üåÆ',t:'Margarita',d:'50ml Tequila ¬∑ 25ml Cointreau ¬∑ 25ml Lima + Sal\nT√©cnica: Shake'},
    {i:'üç∏',t:'Dry Martini',d:'60ml Gin ¬∑ 10ml Vermut seco ¬∑ Twist lim√≥n\nT√©cnica: Stir'},
    {i:'üçπ',t:'Aperol Spritz',d:'90ml Prosecco ¬∑ 60ml Aperol ¬∑ Soda ¬∑ Naranja\nT√©cnica: Build'},
    {i:'ü•É',t:'Whiskey Sour',d:'50ml Bourbon ¬∑ 25ml Lim√≥n ¬∑ 15ml Jarabe ¬∑ Clara\nT√©cnica: Dry Shake + Shake'},
    {i:'üçπ',t:'Cosmopolitan',d:'45ml Vodka citrus ¬∑ 15ml Cointreau ¬∑ 30ml Ar√°ndano ¬∑ 15ml Lima\nT√©cnica: Shake'},
    {i:'üç∏',t:'Espresso Martini',d:'50ml Vodka ¬∑ 30ml Licor caf√© ¬∑ 30ml Espresso\nT√©cnica: Shake'},
    {i:'ü•Ç',t:'French 75',d:'45ml Gin ¬∑ 30ml Lim√≥n ¬∑ 10ml Jarabe ¬∑ Champ√°n\nT√©cnica: Shake + Top'},
    {i:'üçπ',t:'Pi√±a Colada',d:'50ml Ron ¬∑ 30ml Crema coco ¬∑ 90ml Jugo pi√±a\nT√©cnica: Blend'},
  ],
  glosario:[
    {t:'Back',d:'Vaso de agua o soda que acompa√±a un trago corto.'},
    {t:'Dash',d:'~1ml. Unas pocas gotas de amargos u otro ingrediente.'},
    {t:'Jigger',d:'Medidor de bar, generalmente 30/45ml.'},
    {t:'Bar Spoon',d:'Cuchara larga para mezclar. ~5ml.'},
    {t:'Muddler',d:'Instrumento para machacar frutas y hierbas.'},
    {t:'Strainer',d:'Colador. Hawthorne (espiral) o Julep (metal s√≥lido).'},
    {t:'Vermouth',d:'Vino aromatizado, seco o dulce. Base de cl√°sicos.'},
    {t:'Bitters',d:'Concentrado amargo arom√°tico. Angostura, Peychaud\'s.'},
    {t:'Twist',d:'Tira de c√°scara de c√≠trico para aromatizar el borde.'},
    {t:'On the Rocks',d:'Servido sobre hielo.'},
    {t:'Neat',d:'Solo, sin hielo ni diluci√≥n.'},
    {t:'Digestivo',d:'Bebida despu√©s de comer para facilitar la digesti√≥n.'},
  ],
  conv:[
    {h:'üìè Medidas Comunes',r:[['1 oz (onza)','30 ml'],['1 shot','45 ml'],['1 dash','~1 ml'],['1 barspoon','5 ml'],['1 jigger','45 ml']]},
    {h:'‚öñÔ∏è Proporciones Cl√°sicas',r:[['Martini','6:1 Gin:Vermut'],['Manhattan','2:1 Whisky:Vermut'],['Negroni','1:1:1'],['Daiquiri','2:1:1'],['Margarita','2:1:1']]},
    {h:'üçØ Jarabes',r:[['Jarabe 1:1','Partes iguales'],['Jarabe 2:1 (rico)','2 az√∫car : 1 agua'],['Jarabe goma','2:1 + goma ar√°biga']]},
  ],
  tips:[
    {t:'‚ùÑÔ∏è Hielo de Calidad',d:'Un c√≥ctel vale lo mismo que su hielo. Usa cubos grandes y duros para evitar diluci√≥n r√°pida.'},
    {t:'üéØ Siempre Mide',d:'Un buen barman no "calcula", ejecuta. Usa jigger en cada preparaci√≥n para consistencia perfecta.'},
    {t:'üßΩ Mise en Place',d:'Prepara todo antes de servir: herramientas, ingredientes y cristaler√≠a fr√≠a.'},
    {t:'üçã Garnish Inteligente',d:'Usa decoraciones que aporten aroma. Un twist bien hecho transforma un c√≥ctel.'},
    {t:'‚è± Shock T√©rmico',d:'Enfr√≠a la cristaler√≠a antes de servir. Un c√≥ctel caliente destruye la experiencia.'},
    {t:'üí¨ Vende Experiencias',d:'El barman no vende tragos. Sonr√≠e, recomienda y conecta con cada cliente.'},
    {t:'üîÑ Limpieza Constante',d:'Limpia herramientas entre c√≥cteles. Los sabores residuales arruinan el siguiente trago.'},
    {t:'üìö Aprende Cl√°sicos',d:'Domina 10 c√≥cteles cl√°sicos. Todo lo moderno nace de esos fundamentos.'},
  ]
};
function buildAc(){
  document.getElementById('ag-tecnicas').innerHTML=ACD.tecnicas.map(x=>`<div class="acc"><div class="acci">${x.i}</div><div class="acct">${x.t}</div><div class="accd">${x.d}</div></div>`).join('');
  document.getElementById('ag-recetas').innerHTML=ACD.recetas.map(x=>`<div class="acc"><div class="acci">${x.i}</div><div class="acct">${x.t}</div><div class="accd">${x.d}</div></div>`).join('');
  document.getElementById('ag-glosario').innerHTML=ACD.glosario.map(x=>`<div class="gli"><div class="glt">${x.t}</div><div class="gld">${x.d}</div></div>`).join('');
  document.getElementById('ac-conversiones').innerHTML=ACD.conv.map(c=>`<div class="ccard"><h3>${c.h}</h3>${c.r.map(r=>`<div class="crow"><span class="cf2">${r[0]}</span><span class="ct2">${r[1]}</span></div>`).join('')}</div>`).join('');
  document.getElementById('ag-tips').innerHTML=ACD.tips.map(x=>`<div class="tc"><div class="tt">${x.t}</div><div class="td">${x.d}</div></div>`).join('');
}
function setAc(n,el){document.querySelectorAll('[data-ac]').forEach(b=>b.classList.remove('active'));el.classList.add('active');document.querySelectorAll('.acs').forEach(s=>s.classList.remove('active'));document.getElementById('ac-'+n).classList.add('active');}
function filterAc(){const q=document.getElementById('acS').value.toLowerCase();document.querySelectorAll('.acc,.gli,.tc').forEach(el=>{el.style.display=el.innerText.toLowerCase().includes(q)?'':'none';});}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function hStats(){
  document.getElementById('hs-p').textContent=cat.length;
  document.getElementById('hs-i').textContent=inv.length;
  document.getElementById('hs-l').textContent=inv.filter(i=>{const t=i.stock_barra+i.stock_bodega;return t<=(i.min_stock||0)&&(i.min_stock||0)>0;}).length;
  document.getElementById('hs-r').textContent=recs.length;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORTAR EXCEL ‚Üí PRODUCTOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function importXLS(input){
  const file=input.files[0];if(!file)return;
  input.value='';
  const XLSX=window.XLSX;
  if(!XLSX){alert('Libreria XLSX no disponible');return;}

  const ab=await file.arrayBuffer();
  const wb=XLSX.read(ab,{type:'arraybuffer'});
  const ws=wb.Sheets[wb.SheetNames[0]];

  const catMap={'bebida':'Bebida','cerveza':'Cerveza','pisco':'Pisco','ron':'Ron',
    'tequila':'Tequila','vodka':'Vodka','whiskey':'Whiskey','vino':'Vino',
    'gin':'Gin','licor':'Licor','fruta':'Fruta','insumo':'Insumo','base':'Base'};
  const catSet=new Set(Object.keys(catMap));
  const unitMap={'ml':'ml','lt':'lt','gr':'gr','kg':'kg','un':'un','g':'gr','l':'lt'};

  // Extract unit from strings like "24 un", "750 ml"
  const extractUnit=s=>{if(!s)return'un';const m=s.toString().toLowerCase().match(/(ml|lt|gr|kg|un)/);return m?unitMap[m[1]]||'un':'un';};
  const extractNum=s=>{if(!s)return 0;const m=s.toString().match(/[\d.]+/);return m?parseFloat(m[0]):0;};

  const productos=[];

  // Always use raw rows to handle grouped Mixly export format
  const rawRows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
  let isMixlyExport=false;
  let currentCat=null;

  for(const row of rawRows){
    const a=String(row[0]||'').trim();
    if(catSet.has(a.toUpperCase())){isMixlyExport=true;break;}
  }

  if(isMixlyExport){
    const seen=new Set(); // deduplicate
    for(const row of rawRows){
      const a=String(row[0]||'').trim();
      const aUp=a.toUpperCase();
      if(catSet.has(aUp)){currentCat=catMap[aUp];continue;}
      if(!a||a==='Producto'||a.includes('INVENTARIO')||a.includes('MIXLY'))continue;
      if(!currentCat)continue;
      if(seen.has(currentCat+'|'+a))continue; // skip duplicates
      seen.add(currentCat+'|'+a);
      const prov=String(row[1]||'').trim();
      const minRaw=String(row[3]||'').trim();
      const unit=extractUnit(minRaw)||extractUnit(String(row[2]||''))||'un';
      const minStock=extractNum(minRaw);
      productos.push({
        user_id:uid,name:a,category:currentCat,
        unit_type:unit,cantidad_total:1,precio_total:0,price_per_ml:0,
        min_stock:minStock,provider:prov||null
      });
    }
  } else {
    // ‚îÄ‚îÄ FORMAT 2: Flat format (Producto, Categor√≠a, Proveedor, Unidad, ...)
    const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
    const get=(r,...keys)=>{for(const k of keys){const v=r[k];if(v!==undefined&&v!=='')return v;}return '';};
    const parsePPU=v=>{if(!v)return 0;const m=v.toString().replace(/[$,]/g,'').match(/[\d.]+/);return m?parseFloat(m[0]):0;};

    for(const r of rows){
      const nombre=get(r,'Producto','Nombre *','Nombre','nombre').toString().trim();
      if(!nombre||nombre==='Producto'||nombre==='Nombre *')continue;
      if(nombre.includes('importarse')||nombre.includes('Mixly ‚Üí')||nombre.startsWith('‚Üì'))continue;
      const catRaw=get(r,'Categoria','Categor√≠a','categoria','Categor√≠a *','category').toString().trim().toLowerCase();
      const unitRaw=get(r,'Unidad','unidad').toString().trim().toLowerCase();
      const prov=get(r,'Proveedor','proveedor').toString().trim();
      const minSt=parseFloat(get(r,'Minimo','M√≠nimo','min_stock','Stock m√≠nimo'))||0;
      let qty=parseFloat(get(r,'Cantidad total','cantidad_total'))||1;
      let precio=parseFloat(get(r,'Precio total ($)','Precio total','precio_total'))||0;
      const ppu=parsePPU(get(r,'Precio/u','precio_u','Precio/unidad'));
      if(!precio&&ppu)precio=ppu*qty;
      productos.push({
        user_id:uid,name:nombre,
        category:catMap[catRaw]||'Insumo',
        unit_type:unitMap[unitRaw]||'un',
        cantidad_total:qty||1,precio_total:precio,
        price_per_ml:qty>0?precio/qty:ppu,
        min_stock:minSt,provider:prov||null
      });
    }
  }

  if(!productos.length){alert('No se encontraron productos en el archivo.');return;}

  const preview=productos.slice(0,4).map(p=>p.name).join(', ')+(productos.length>4?' y '+(productos.length-4)+' m√°s...':'');
  const conf=confirm('Se importar√°n '+productos.length+' productos: '+preview+'. Esto NO elimina los existentes. Continuar?');
  if(!conf)return;

  ok('p-ok','Importando '+productos.length+' productos...');
  let count=0,errors=0;
  for(let i=0;i<productos.length;i+=20){
    const{error}=await db.from('products').insert(productos.slice(i,i+20));
    if(error){console.error('Batch error:',error);errors+=20;}
    else count+=Math.min(20,productos.length-i);
  }

  await lCat();await lInv();renderP();renderI();hStats();
  if(errors>0)er('p-er',errors+' productos no pudieron importarse');
  else ok('p-ok','‚úì '+count+' productos importados correctamente');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DARK MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleDM(){
  const isDark=document.documentElement.classList.toggle('dark');
  localStorage.setItem('mixly-theme',isDark?'dark':'light');
  document.getElementById('dmIc').textContent=isDark?'‚òÄÔ∏è':'üåô';
  document.getElementById('dmLb').textContent=isDark?'Light':'Dark';
  document.getElementById('dmToggle').title=isDark?'Modo claro':'Modo oscuro';
}
// Restore on load
(function(){
  const saved=localStorage.getItem('mixly-theme');
  const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(saved==='dark'||((!saved)&&prefersDark)){
    document.documentElement.classList.add('dark');
    // Icons set after DOM ready
    window.addEventListener('DOMContentLoaded',()=>{
      const ic=document.getElementById('dmIc'),lb=document.getElementById('dmLb');
      if(ic)ic.textContent='‚òÄÔ∏è';
      if(lb)lb.textContent='Light';
    });
  }
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUSCADOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let bFilt='all';
function initBuscador(){doSearch();}
function setBF(f,el){
  bFilt=f;
  document.querySelectorAll('[data-bf]').forEach(b=>b.classList.toggle('active',b.dataset.bf===f));
  doSearch();
}
function doSearch(){
  const q=(document.getElementById('bqInput')?.value||'').toLowerCase().trim();
  let list=recs;
  if(bFilt!=='all') list=list.filter(r=>r.profile===bFilt);
  if(q) list=list.filter(r=>{
    if(r.name.toLowerCase().includes(q)) return true;
    if((r.description||'').toLowerCase().includes(q)) return true;
    if((r.profile||'').toLowerCase().includes(q)) return true;
    if(Array.isArray(r.ingredients)&&r.ingredients.some(i=>(i.name||'').toLowerCase().includes(q))) return true;
    return false;
  });
  const stats=document.getElementById('bqStats');
  const res=document.getElementById('bqResults');
  if(!recs.length){
    stats.textContent='';
    res.innerHTML='<div class="empty"><div class="ei">üìñ</div><p>No hay recetas guardadas a√∫n.<br><a href="javascript:sp(\'recipes\')" style="color:var(--a2)">Crea tu primera receta ‚Üí</a></p></div>';
    return;
  }
  stats.textContent=list.length+' receta'+(list.length!==1?'s':'')+(q?' para "'+q+'"':'')+' encontrada'+(list.length!==1?'s':'');
  if(!list.length){
    res.innerHTML='<div class="empty"><div class="ei">üîç</div><p>Sin resultados para "'+q+'"</p></div>';
    return;
  }
  const profEmoji={dulce:'üç¨',suave:'üå∏',seco:'üçã',fuerte:'üî•','extra-fuerte':'üí•'};
  // Highlight matching text
  const hl=txt=>q?txt.replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark style="background:rgba(0,194,255,.25);border-radius:3px;padding:0 2px">$1</mark>'):txt;
  res.innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">'+
    list.map(r=>{
      const ings=Array.isArray(r.ingredients)?r.ingredients:[];
      const ingList=ings.map(i=>`<span style="display:inline-block;background:var(--s2);border:1px solid var(--b2);border-radius:20px;padding:2px 8px;font-size:.68rem;color:var(--t2);margin:2px">${hl(i.name||'')} <span style="color:var(--t3)">${i.quantity||''}${i.unit||''}</span></span>`).join('');
      return`<div class="card" style="cursor:pointer" onclick="openFichaModal(${r.id})">
        <div class="ch" style="gap:8px">
          <div style="flex:1">
            <div style="font-family:'Syne',sans-serif;font-size:.85rem;font-weight:800;letter-spacing:1px">${hl(r.name)}</div>
            ${r.description?`<div style="font-size:.72rem;color:var(--t3);margin-top:2px">${hl(r.description)}</div>`:''}
          </div>
          ${r.profile?`<span style="font-size:1.1rem">${profEmoji[r.profile]||'üçπ'}</span>`:''}
        </div>
        <div class="cb" style="padding:14px 22px">
          <div style="margin-bottom:10px;line-height:1.8">${ingList||'<span style="font-size:.72rem;color:var(--t3)">Sin ingredientes</span>'}</div>
          ${r.total_cost?`<div style="font-size:.72rem;color:var(--a2);font-weight:700">Costo: $${Number(r.total_cost).toFixed(0)}</div>`:''}
        </div>
      </div>`;
    }).join('')+'</div>';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TIMERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let timers=[];
function tmPreset(name,min,sec,emoji){
  document.getElementById('tmName').value=name;
  document.getElementById('tmMin').value=min;
  document.getElementById('tmSec').value=sec;
  document.getElementById('tmEmoji').value=emoji;
}
function addTimer(){
  const name=document.getElementById('tmName').value.trim()||'Timer';
  const min=parseInt(document.getElementById('tmMin').value)||0;
  const sec=parseInt(document.getElementById('tmSec').value)||0;
  const emoji=document.getElementById('tmEmoji').value.trim()||'‚è±';
  const total=min*60+sec;
  if(total<=0){alert('Ingresa una duraci√≥n v√°lida');return;}
  const id=Date.now();
  timers.push({id,name,emoji,total,remaining:total,running:true,interval:null,done:false});
  document.getElementById('tmName').value='';
  document.getElementById('tmMin').value='';
  document.getElementById('tmSec').value='';
  document.getElementById('tmEmoji').value='';
  const t=timers[timers.length-1];
  t.interval=setInterval(()=>tickTimer(t.id),1000);
  renderTimers();
}
function tickTimer(id){
  const t=timers.find(x=>x.id===id);
  if(!t||!t.running)return;
  t.remaining--;
  if(t.remaining<=0){
    t.remaining=0;t.running=false;t.done=true;
    clearInterval(t.interval);
    // Sound notification
    try{const ctx=new(window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator(),g=ctx.createGain();
      osc.connect(g);g.connect(ctx.destination);
      osc.frequency.value=880;g.gain.setValueAtTime(0.3,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.8);
      osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.8);
    }catch(e){}
    // Browser notification
    if(Notification.permission==='granted'){
      new Notification('‚è± '+t.emoji+' '+t.name+' listo!',{body:'Tu timer termin√≥',icon:'logo.png'});
    }
  }
  renderTimers();
}
function toggleTimer(id){
  const t=timers.find(x=>x.id===id);if(!t||t.done)return;
  t.running=!t.running;
  if(t.running){t.interval=setInterval(()=>tickTimer(t.id),1000);}
  else{clearInterval(t.interval);}
  renderTimers();
}
function resetTimer(id){
  const t=timers.find(x=>x.id===id);if(!t)return;
  clearInterval(t.interval);
  t.remaining=t.total;t.running=false;t.done=false;
  renderTimers();
}
function removeTimer(id){
  const t=timers.find(x=>x.id===id);
  if(t)clearInterval(t.interval);
  timers=timers.filter(x=>x.id!==id);
  renderTimers();
}
function fmtTime(s){const m=Math.floor(s/60),sc=s%60;return String(m).padStart(2,'0')+':'+String(sc).padStart(2,'0');}
function renderTimers(){
  const el=document.getElementById('tmList');
  const empty=document.getElementById('tmEmpty');
  if(!timers.length){el.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  el.innerHTML=timers.map(t=>{
    const pct=t.total>0?(1-t.remaining/t.total)*100:100;
    const color=t.done?'var(--ok)':t.remaining<30?'var(--danger)':t.remaining<t.total*0.25?'var(--warn)':'var(--accent)';
    const bgCard=t.done?'background:var(--obg);border-color:rgba(16,185,129,.3)':'';
    return`<div class="card" style="${bgCard};transition:.3s">
      <div class="cb" style="text-align:center;padding:22px 18px">
        <div style="font-size:2rem;margin-bottom:6px">${t.emoji}</div>
        <div style="font-family:'Syne',sans-serif;font-size:.72rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--t2);margin-bottom:10px">${t.name}</div>
        <div style="font-family:'Syne',sans-serif;font-size:2.6rem;font-weight:800;color:${color};line-height:1;margin-bottom:14px;letter-spacing:2px">
          ${t.done?'‚úì LISTO':fmtTime(t.remaining)}
        </div>
        <!-- Progress bar -->
        <div style="height:4px;background:var(--b2);border-radius:4px;margin-bottom:16px;overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;transition:width .9s linear"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:center">
          ${!t.done?`<button class="btn ${t.running?'bw':'bp'} sm" onclick="toggleTimer(${t.id})">${t.running?'‚è∏ Pausar':'‚ñ∂ Reanudar'}</button>`:''}
          <button class="btn bs sm" onclick="resetTimer(${t.id})">‚Ü∫ Reset</button>
          <button class="btn bd sm" onclick="removeTimer(${t.id})">‚úï</button>
        </div>
      </div>
    </div>`;
  }).join('');
}
// Request notification permission
if('Notification' in window&&Notification.permission==='default'){
  Notification.requestPermission();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FICHAS T√âCNICAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let fFilt2='all';
function setFP2(f,el){
  fFilt2=f;
  document.querySelectorAll('[data-fp2]').forEach(b=>b.classList.toggle('active',b.dataset.fp2===f));
  renderFichas();
}
function renderFichas(){
  const q=(document.getElementById('fqInput')?.value||'').toLowerCase();
  let list=recs;
  if(fFilt2!=='all') list=list.filter(r=>r.profile===fFilt2);
  if(q) list=list.filter(r=>r.name.toLowerCase().includes(q)||(r.description||'').toLowerCase().includes(q));
  const grid=document.getElementById('fqGrid');
  if(!list.length){
    grid.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="ei">üìã</div><p>No hay recetas</p></div>';
    return;
  }
  const profEmoji={dulce:'üç¨',suave:'üå∏',seco:'üçã',fuerte:'üî•','extra-fuerte':'üí•'};
  const profLabel={dulce:'Dulce',suave:'Suave',seco:'Seco',fuerte:'Fuerte','extra-fuerte':'Extra fuerte'};
  grid.innerHTML=list.map(r=>{
    const ings=Array.isArray(r.ingredients)?r.ingredients:[];
    return`<div class="card" style="break-inside:avoid">
      <!-- Header ficha -->
      <div style="background:linear-gradient(135deg,${r.color||'#00C2FF'},${r.color?r.color+'CC':'#0090CC'});padding:20px 22px;position:relative">
        <div style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:#fff">${r.name}</div>
        ${r.description?`<div style="font-size:.75rem;color:rgba(255,255,255,.75);margin-top:4px">${r.description}</div>`:''}
        <div style="position:absolute;top:16px;right:18px;font-size:1.5rem">${profEmoji[r.profile]||'üçπ'}</div>
      </div>
      <div class="cb" style="padding:18px 22px">
        <!-- Ingredientes -->
        <div style="margin-bottom:16px">
          <div style="font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">Ingredientes</div>
          ${ings.length?ings.map((ing,i)=>`
            <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;${i<ings.length-1?'border-bottom:1px solid var(--b2)':''}">
              <span style="font-size:.82rem;color:var(--text)">${ing.name||''}</span>
              <span style="font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;color:var(--a2)">${ing.quantity||''}${ing.unit||''}</span>
            </div>`).join(''):'<span style="font-size:.75rem;color:var(--t3)">Sin ingredientes</span>'}
        </div>
        <!-- Preparaci√≥n -->
        ${r.preparation?`
        <div style="margin-bottom:14px">
          <div style="font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:8px">Preparaci√≥n</div>
          <div style="font-size:.78rem;color:var(--t2);line-height:1.65;white-space:pre-line">${r.preparation}</div>
        </div>`:''}
        <!-- Footer ficha -->
        <div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid var(--b2);flex-wrap:wrap;gap:8px">
          ${r.profile?`<span style="font-size:.65rem;background:var(--abg);border:1px solid rgba(0,194,255,.2);border-radius:20px;padding:3px 10px;color:var(--a2);font-weight:700">${profEmoji[r.profile]} ${profLabel[r.profile]||r.profile}</span>`:'<span></span>'}
          ${r.total_cost?`<span style="font-size:.72rem;color:var(--t3);font-weight:600">Costo: <strong style="color:var(--a2)">$${Number(r.total_cost).toFixed(0)}</strong></span>`:''}
          <button class="btn bs sm" onclick="printFicha(${r.id})" style="margin-left:auto">üñ® Imprimir</button>
        </div>
      </div>
    </div>`;
  }).join('');
}
function printFicha(id){
  const r=recs.find(x=>x.id===id);if(!r)return;
  const ings=Array.isArray(r.ingredients)?r.ingredients:[];
  const profEmoji={dulce:'üç¨',suave:'üå∏',seco:'üçã',fuerte:'üî•','extra-fuerte':'üí•'};
  const w=window.open('','_blank','width=600,height=800');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
    <title>Ficha ¬∑ ${r.name}</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:'Helvetica Neue',Arial,sans-serif;padding:32px;color:#0A1628;max-width:500px;margin:0 auto}
      h1{font-size:1.6rem;font-weight:900;letter-spacing:3px;text-transform:uppercase;margin-bottom:4px}
      .sub{font-size:.8rem;color:#7A9EC0;margin-bottom:20px}
      .sec{font-size:.55rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#7A9EC0;margin-bottom:8px;border-bottom:1px solid #eee;padding-bottom:4px}
      .ing{display:flex;justify-content:space-between;padding:5px 0;font-size:.85rem;border-bottom:1px solid #f0f0f0}
      .ing:last-child{border-bottom:none}
      .ing .qty{font-weight:700;color:#0090CC}
      .prep{font-size:.82rem;line-height:1.7;color:#3A5A80;white-space:pre-line;margin-bottom:20px}
      .footer{display:flex;justify-content:space-between;font-size:.72rem;color:#aaa;margin-top:20px;padding-top:12px;border-top:1px solid #eee}
      .accent{color:#00C2FF}
      @media print{body{padding:20px}button{display:none}}
    </style>
  </head><body>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
      <div>
        <h1>${r.name}</h1>
        ${r.description?`<div class="sub">${r.description}</div>`:'<div style="margin-bottom:20px"></div>'}
      </div>
      <div style="font-size:2rem">${profEmoji[r.profile]||'üçπ'}</div>
    </div>
    <div class="sec">Ingredientes</div>
    <div style="margin-bottom:20px">
      ${ings.map(i=>`<div class="ing"><span>${i.name||''}</span><span class="qty">${i.quantity||''}${i.unit||''}</span></div>`).join('')||'<p style="font-size:.8rem;color:#aaa">Sin ingredientes</p>'}
    </div>
    ${r.preparation?`<div class="sec">Preparaci√≥n</div><div class="prep">${r.preparation}</div>`:''}
    <div class="footer">
      <span>MIXLY Bar Management</span>
      ${r.total_cost?`<span>Costo estimado: <strong class="accent">$${Number(r.total_cost).toFixed(0)}</strong></span>`:''}
    </div>
    <script>window.onload=()=>window.print()<\/script>
  </body></html>`);
  w.document.close();
}
function openFichaModal(id){sp('fichas');setTimeout(()=>{const r=recs.find(x=>x.id===id);if(r)printFicha(id);},200);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const OB_STEPS = [
  {
    emoji: 'üëã',
    title: '¬°Hola, bienvenido a Mixly!',
    sub: 'Tu barra va a agradecer esto',
    desc: 'Este tour r√°pido te va a mostrar todo lo que necesitas para dominar la app en menos de 2 minutos. ¬°Es pan comido!',
    tip: 'üí° <strong>Dato:</strong> Mixly recuerda tus datos autom√°ticamente, as√≠ que no necesitas guardar nada manualmente.',
    target: null,
    panel: 'home'
  },
  {
    emoji: 'üì¶',
    title: 'Productos',
    sub: 'El coraz√≥n de tu inventario',
    desc: 'Ac√° viven todos tus insumos: licores, frutas, bases y m√°s. Cada producto tiene precio, unidad y stock m√≠nimo. Si no est√° ac√°, no existe en el bar.',
    tip: 'üí° <strong>Pro tip:</strong> Agrega el stock m√≠nimo de cada producto y Mixly te avisar√° cuando est√©s por quedarte sin.',
    target: 'productos',
    panel: 'productos'
  },
  {
    emoji: 'üìä',
    title: 'Inventario',
    sub: 'Lo que hay hoy en el bar',
    desc: 'Ac√° actualizas el stock real de lo que tienes en Barra y Bodega. Los n√∫meros con fondo de color te dicen cu√°nto pedir ‚Äî solo escribe la cantidad en el campo "A pedir".',
    tip: 'üí° <strong>Colores:</strong> üî¥ Sin stock ¬∑ üü† Muy bajo ¬∑ üü° Bajo ¬∑ üü¢ OK',
    target: 'inventory',
    panel: 'inventory'
  },
  {
    emoji: 'üîç',
    title: 'Buscador',
    sub: 'Encuentra cualquier receta al tiro',
    desc: 'Escribe un ingrediente, un nombre o un perfil de sabor y aparecen todas las recetas que lo usan. Perfecto para el rush del servicio cuando no recuerdas proporciones.',
    tip: 'üí° <strong>Tip:</strong> Busca "gin" y aparecen todos los tragos que lo llevan. ¬°S√∫per √∫til con clientes esperando!',
    target: 'buscador',
    panel: 'buscador'
  },
  {
    emoji: '‚è±',
    title: 'Timers',
    sub: 'Nunca m√°s se te pasa el jarabe',
    desc: 'Crea timers con nombre propio para jarabes, macerados, infusiones y t√©cnicas. Puedes correr varios al mismo tiempo y suena una alerta cuando terminan.',
    tip: 'üí° <strong>Presets listos:</strong> Jarabe, Macerado, Reducci√≥n, Shake, Stir e Infusi√≥n. Un clic y listo.',
    target: 'timers',
    panel: 'timers'
  },
  {
    emoji: 'üìã',
    title: 'Fichas T√©cnicas',
    sub: 'Recetas profesionales para tu equipo',
    desc: 'Todas tus recetas en formato ficha profesional con ingredientes, cantidades y preparaci√≥n. Imprime la que necesites y p√©gala en la barra para que el equipo siempre tenga la referencia.',
    tip: 'üí° <strong>Imprime:</strong> Cada ficha tiene bot√≥n de impresi√≥n con dise√±o limpio, listo para plastificar.',
    target: 'fichas',
    panel: 'fichas'
  },
  {
    emoji: 'üöÄ',
    title: '¬°Ya eres un crack de Mixly!',
    sub: 'Tu barra est√° lista para brillar',
    desc: 'Tienes todo lo que necesitas. Si en alg√∫n momento quieres volver a ver este tour, presiona el bot√≥n <strong>?</strong> en la esquina inferior derecha.',
    tip: 'üéâ <strong>¬°A trabajar!</strong> Empieza agregando tus productos y armando tus recetas. El resto viene solo.',
    target: null,
    panel: 'home'
  }
];

let obCurrent = 0;
let obActive = false;

function startOB(force=false){
  // Check localStorage ‚Äî only show once per user unless forced
  const uid2 = uid || 'guest';
  const key = 'mixly-ob-done-' + uid2;
  if(!force && localStorage.getItem(key)) return;

  obActive = true;
  obCurrent = 0;
  const ov = document.getElementById('obOverlay');
  ov.style.display = 'block';
  requestAnimationFrame(()=> ov.classList.add('active'));
  document.getElementById('obHelpBtn').style.display = 'none';
  buildProgress();
  showStep(0);
}

function obSkip(){
  endOB();
}

function obStep(dir){
  const next = obCurrent + dir;
  if(next < 0) return;
  if(next >= OB_STEPS.length){ endOB(); return; }
  obCurrent = next;
  showStep(obCurrent);
}

function showStep(i){
  const s = OB_STEPS[i];
  const isLast = i === OB_STEPS.length - 1;
  const isFirst = i === 0;

  // Navigate to panel
  if(s.panel) sp(s.panel);

  // Update card content
  document.getElementById('obEmoji').textContent = s.emoji;
  document.getElementById('obTitle').textContent = s.title;
  document.getElementById('obSub').textContent = s.sub;
  document.getElementById('obDesc').innerHTML = s.desc;
  document.getElementById('obTip').innerHTML = s.tip;
  document.getElementById('obPrev').style.display = isFirst ? 'none' : '';
  document.getElementById('obNext').textContent = isLast ? '‚úì ¬°Empezar!' : 'Siguiente ‚Üí';

  // Update progress dots
  document.querySelectorAll('.ob-dot').forEach((d,idx)=>{
    d.classList.remove('active','done');
    if(idx < i) d.classList.add('done');
    else if(idx === i) d.classList.add('active');
  });

  // Spotlight target
  const spot = document.getElementById('obSpot');
  const card = document.getElementById('obCard');

  // Always center the card horizontally on screen ‚Äî avoid sidebar overlap
  const cardW = 320;
  const winW = window.innerWidth;
  const winH = window.innerHeight;
  const cardH = 420; // approximate

  if(s.target){
    const el = document.querySelector('.ni[data-p="'+s.target+'"]');
    if(el){
      const r = el.getBoundingClientRect();
      const pad = 6;
      spot.style.cssText = 'left:'+(r.left-pad)+'px;top:'+(r.top-pad)+'px;width:'+(r.width+pad*2)+'px;height:'+(r.height+pad*2)+'px;opacity:1;transition:all .45s cubic-bezier(.4,0,.2,1)';
    }
  } else {
    spot.style.opacity = '0';
  }

  // Center card in the content area (to the right of sidebar ~72px)
  const sidebarW = 72;
  const contentW = winW - sidebarW;
  const cardLeft = sidebarW + (contentW - cardW) / 2;
  const cardTop = Math.max(20, (winH - cardH) / 2);

  card.style.left = cardLeft + 'px';
  card.style.top = cardTop + 'px';
  card.style.right = 'auto';
  card.style.bottom = 'auto';
  card.style.transform = '';
}

function buildProgress(){
  const el = document.getElementById('obProgress');
  el.innerHTML = OB_STEPS.map((_,i)=>`<div class="ob-dot${i===0?' active':''}"></div>`).join('');
}

function endOB(){
  obActive = false;
  const overlay = document.getElementById('obOverlay');
  overlay.classList.remove('active');
  setTimeout(()=>{ overlay.style.display='none'; }, 350);
  document.getElementById('obSpot').style.opacity = '0';
  // Reset card position
  const card = document.getElementById('obCard');
  card.style.transform = '';
  // Go home
  sp('home');
  // Save to localStorage
  const uid2 = uid || 'guest';
  localStorage.setItem('mixly-ob-done-'+uid2, '1');
  // Show help button
  setTimeout(()=>{ document.getElementById('obHelpBtn').style.display = 'flex'; }, 600);
}

// Start onboarding after login ‚Äî called from initApp
function maybeStartOB(){
  const uid2 = uid || 'guest';
  const key = 'mixly-ob-done-' + uid2;
  if(!localStorage.getItem(key)){
    setTimeout(()=> startOB(false), 800);
  } else {
    document.getElementById('obHelpBtn').style.display = 'flex';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function lgsTab(tab){
  const tabs=['login','register','forgot','reset'];
  tabs.forEach(t=>{
    document.getElementById('lgs'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.toggle('active',t===tab);
  });
  document.querySelectorAll('.lgs-tab').forEach(b=>b.classList.remove('active'));
  if(tab==='login'||tab==='register'){
    document.getElementById('lgsTabs').style.display='';
    document.querySelector('.lgs-tab[onclick*="'+tab+'"]')?.classList.add('active');
  } else {
    document.getElementById('lgsTabs').style.display='none';
  }
  lgsHideAlert();
}

function lgsShowAlert(msg,type='err'){
  const el=document.getElementById('lgsAlert');
  el.textContent=msg;
  el.className='lgs-alert show '+type;
}
function lgsHideAlert(){
  const el=document.getElementById('lgsAlert');
  if(el) el.className='lgs-alert';
}

async function lgsLogin(){
  const email=document.getElementById('lgsEmail').value.trim();
  const pass=document.getElementById('lgsPass').value;
  if(!email||!pass){lgsShowAlert('Completa todos los campos');return;}
  const btn=document.querySelector('#lgsLogin .lgs-btn');
  btn.disabled=true;btn.textContent='Ingresando...';
  const{error}=await db.auth.signInWithPassword({email,password:pass});
  btn.disabled=false;btn.textContent='Entrar ‚Üí';
  if(error){
    if(error.message.includes('Email not confirmed'))
      lgsShowAlert('Debes confirmar tu correo antes de entrar');
    else if(error.message.includes('Invalid login'))
      lgsShowAlert('Correo o contrase√±a incorrectos');
    else lgsShowAlert(error.message);
  }
}

async function lgsRegister(){
  const email=document.getElementById('lgsRegEmail').value.trim();
  const barName=document.getElementById('lgsBarName').value.trim();
  const username=document.getElementById('lgsUsername').value.trim();
  const pass=document.getElementById('lgsRegPass').value;
  const pass2=document.getElementById('lgsRegPass2').value;
  if(!email||!barName||!username||!pass){lgsShowAlert('Completa todos los campos');return;}
  if(pass!==pass2){lgsShowAlert('Las contrase√±as no coinciden');return;}
  if(pass.length<6){lgsShowAlert('La contrase√±a debe tener al menos 6 caracteres');return;}
  const btn=document.querySelector('#lgsRegister .lgs-btn');
  btn.disabled=true;btn.textContent='Creando cuenta...';
  const{error}=await db.auth.signUp({email,password:pass,
    options:{data:{username,bar_name:barName}}});
  btn.disabled=false;btn.textContent='Crear cuenta';
  if(error){
    if(error.message.includes('already registered'))
      lgsShowAlert('Este correo ya est√° registrado');
    else lgsShowAlert(error.message);
    return;
  }
  lgsShowAlert('‚úì Cuenta creada. Revisa tu correo para confirmar tu cuenta.','ok');
  setTimeout(()=>{
    lgsTab('login');
    document.getElementById('lgsEmail').value=email;
  },3000);
}

async function lgsForgot(){
  const email=document.getElementById('lgsForgotEmail').value.trim();
  if(!email){lgsShowAlert('Ingresa tu correo');return;}
  const{error}=await db.auth.resetPasswordForEmail(email,{
    redirectTo:window.location.origin+window.location.pathname});
  if(error){lgsShowAlert(error.message);return;}
  lgsShowAlert('‚úì Correo enviado. Revisa tu bandeja de entrada.','ok');
  setTimeout(()=>lgsTab('login'),3000);
}

async function lgsUpdatePass(){
  const p1=document.getElementById('lgsNewPass').value;
  const p2=document.getElementById('lgsNewPass2').value;
  if(!p1||!p2){lgsShowAlert('Completa ambos campos');return;}
  if(p1!==p2){lgsShowAlert('Las contrase√±as no coinciden');return;}
  if(p1.length<6){lgsShowAlert('M√≠nimo 6 caracteres');return;}
  const{error}=await db.auth.updateUser({password:p1});
  if(error){lgsShowAlert(error.message);return;}
  lgsShowAlert('‚úì Contrase√±a actualizada. Redirigiendo...','ok');
  setTimeout(async()=>{
    await db.auth.signOut();
    window.location.hash='';
    document.getElementById('loginScreen').classList.add('show');
    lgsTab('login');
  },2000);
}

// Enter key support
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  const ls=document.getElementById('loginScreen');
  if(!ls?.classList.contains('show'))return;
  const active=document.querySelector('.lgs-form.active')?.id;
  if(active==='lgsLogin')lgsLogin();
  else if(active==='lgsRegister')lgsRegister();
  else if(active==='lgsForgot')lgsForgot();
  else if(active==='lgsReset')lgsUpdatePass();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORTAR CAT√ÅLOGO COMPLETO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function expCatalogo(){
  if(!cat.length){alert('No hay productos para exportar');return;}
  const ExcelJS=window.ExcelJS;
  if(!ExcelJS){alert('Librer√≠a no disponible');return;}

  const wb=new ExcelJS.Workbook();
  wb.creator='Mixly';wb.created=new Date();
  const ws=wb.addWorksheet('Cat√°logo');

  // Column definitions
  ws.columns=[
    {header:'Nombre',key:'name',width:30},
    {header:'Categor√≠a',key:'category',width:14},
    {header:'Proveedor',key:'provider',width:20},
    {header:'Unidad',key:'unit_type',width:10},
    {header:'Cantidad total',key:'cantidad_total',width:14},
    {header:'Precio total ($)',key:'precio_total',width:16},
    {header:'Precio/unidad',key:'price_per_ml',width:14},
    {header:'Stock m√≠nimo',key:'min_stock',width:13},
  ];

  // Header style
  const hRow=ws.getRow(1);
  hRow.eachCell(cell=>{
    cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0A1628'}};
    cell.font={bold:true,color:{argb:'FFFFFFFF'},size:10,name:'Calibri'};
    cell.alignment={vertical:'middle',horizontal:'center'};
    cell.border={bottom:{style:'medium',color:{argb:'FF00C2FF'}}};
  });
  hRow.height=22;

  // Data rows sorted by category > provider > name
  const sorted=[...cat].sort((a,b)=>
    (a.category||'').localeCompare(b.category||'','es')||
    (a.provider||'').localeCompare(b.provider||'','es')||
    (a.name||'').localeCompare(b.name||'','es')
  );

  const catColors={
    'Bebida':'FFBBDEFB','Cerveza':'FFFFE0B2','Pisco':'FFFCE4EC',
    'Ron':'FFF3E5F5','Tequila':'FFFFF8E1','Vodka':'FFE8EAF6',
    'Whiskey':'FFEFEBE9','Vino':'FFF3E5F5','Gin':'FFE0F7FA',
    'Licor':'FFEDE7F6','Fruta':'FFE8F5E9','Insumo':'FFF1F8E9','Base':'FFECEFF1'
  };

  sorted.forEach((p,i)=>{
    const row=ws.addRow({
      name:p.name,
      category:p.category||'',
      provider:p.provider||'',
      unit_type:p.unit_type||'un',
      cantidad_total:p.cantidad_total||1,
      precio_total:p.precio_total||0,
      price_per_ml:p.price_per_ml||0,
      min_stock:p.min_stock||0,
    });
    const bg=catColors[p.category]||'FFFFFFFF';
    row.eachCell(cell=>{
      cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
      cell.alignment={vertical:'middle'};
      cell.border={bottom:{style:'thin',color:{argb:'FFE0E0E0'}}};
      cell.font={name:'Calibri',size:10};
    });
    row.height=18;
  });

  // Format price columns
  [6,7].forEach(c=>{
    ws.getColumn(c).numFmt='"$"#,##0.00';
  });

  // Title row at top
  ws.spliceRows(1,0,[]);
  const titleRow=ws.getRow(1);
  ws.mergeCells('A1:H1');
  const titleCell=ws.getCell('A1');
  const now=new Date();
  titleCell.value=`CAT√ÅLOGO MIXLY ¬∑ ${now.toLocaleDateString('es-CL',{day:'2-digit',month:'long',year:'numeric'}).toUpperCase()}`;
  titleCell.font={bold:true,size:13,color:{argb:'FF00C2FF'},name:'Calibri'};
  titleCell.alignment={horizontal:'center',vertical:'middle'};
  titleCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF0A1628'}};
  titleRow.height=28;

  const buf=await wb.xlsx.writeBuffer();
  const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const fecha=new Date().toISOString().slice(0,10);
  a.download=`Catalogo_Mixly_${fecha}.xlsx`;
  a.click();URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORTAR PARA COMPARTIR (importable por otro usuario) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function expCatalogoShare(){
  if(!cat.length){alert('No hay productos para exportar');return;}
  const ExcelJS=window.ExcelJS;
  if(!ExcelJS){alert('Librer√≠a no disponible');return;}

  const wb=new ExcelJS.Workbook();
  const ws=wb.addWorksheet('Productos');

  ws.columns=[
    {header:'Nombre *',key:'name',width:32},
    {header:'Categor√≠a *',key:'category',width:14},
    {header:'Proveedor',key:'provider',width:20},
    {header:'Unidad *',key:'unit_type',width:10},
    {header:'Cantidad total',key:'cantidad_total',width:14},
    {header:'Precio total ($)',key:'precio_total',width:16},
    {header:'Stock m√≠nimo',key:'min_stock',width:13},
  ];

  // Header style ‚Äî accent color
  const hRow=ws.getRow(1);
  hRow.eachCell(cell=>{
    cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF00C2FF'}};
    cell.font={bold:true,color:{argb:'FF0A1628'},size:10,name:'Calibri'};
    cell.alignment={vertical:'middle',horizontal:'center'};
  });
  hRow.height=22;

  // Instructions row
  ws.spliceRows(2,0,[]);
  const instrRow=ws.getRow(2);
  ws.mergeCells('A2:G2');
  const instrCell=ws.getCell('A2');
  instrCell.value='‚Üì Este archivo puede importarse directamente en Mixly ‚Üí Productos ‚Üí Importar Excel';
  instrCell.font={italic:true,color:{argb:'FF3A5A80'},size:9,name:'Calibri'};
  instrCell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFE3F2FD'}};
  instrCell.alignment={horizontal:'center',vertical:'middle'};
  instrRow.height=16;

  // Data ‚Äî sorted
  const sorted=[...cat].sort((a,b)=>
    (a.category||'').localeCompare(b.category||'','es')||
    (a.provider||'').localeCompare(b.provider||'','es')||
    (a.name||'').localeCompare(b.name||'','es')
  );

  sorted.forEach((p,i)=>{
    const row=ws.addRow({
      name:p.name,
      category:p.category||'',
      provider:p.provider||'',
      unit_type:p.unit_type||'un',
      cantidad_total:p.cantidad_total||1,
      precio_total:p.precio_total||0,
      min_stock:p.min_stock||0,
    });
    const bg=i%2===0?'FFFFFFFF':'FFF8FBFF';
    row.eachCell(cell=>{
      cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
      cell.alignment={vertical:'middle'};
      cell.border={bottom:{style:'thin',color:{argb:'FFE8EEF4'}}};
      cell.font={name:'Calibri',size:10};
    });
    row.height=18;
  });

  // Valid categories note in last column
  ws.getCell('H1').value='Categor√≠as v√°lidas:';
  ws.getCell('H1').font={bold:true,size:9,name:'Calibri'};
  const cats2=['Bebida','Cerveza','Pisco','Ron','Tequila','Vodka','Whiskey','Vino','Gin','Licor','Fruta','Insumo','Base'];
  cats2.forEach((c,i)=>{
    ws.getCell(`H${i+3}`).value=c;
    ws.getCell(`H${i+3}`).font={size:9,name:'Calibri',color:{argb:'FF3A5A80'}};
  });
  ws.getColumn('H').width=14;

  const buf=await wb.xlsx.writeBuffer();
  const blob=new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const fecha=new Date().toISOString().slice(0,10);
  a.download=`Mixly_Compartir_${fecha}.xlsx`;
  a.click();URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTOCOMPLETE INGREDIENTES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let acActive=-1;
window.acRI=function(id){
  const inp=document.getElementById('rn-'+id);
  const list=document.getElementById('ac-'+id);
  const q=(inp?.value||'').trim().toLowerCase();
  acActive=-1;
  if(!q){list.classList.remove('show');list.innerHTML='';return;}

  // Search in products
  const matches=cat.filter(p=>p.name.toLowerCase().includes(q)).slice(0,6);
  const escQ=q.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&');
  const items=matches.map((p,i)=>{
    const hl=p.name.replace(new RegExp('('+escQ+')','gi'),
      '<strong style="color:var(--accent)">$1</strong>');
    return `<div class="ing-ac-item" data-idx="${i}"
      onmousedown="acSel(${id},'${p.name.replace(/'/g,"\'")}',${p.id},${p.price_per_ml||0},'${p.unit_type||'un'}')">
      ${hl}
      <span class="ac-badge">${p.category||''}</span>
      ${p.provider?`<span class="ac-badge">${p.provider}</span>`:''}
    </div>`;
  });

  // Always show "usar tal cual" option if not exact match
  const exactMatch=cat.some(p=>p.name.toLowerCase()===q);
  if(!exactMatch){
    items.push(`<div class="ing-ac-item" data-idx="${matches.length}"
      onmousedown="acSel(${id},'${inp.value.replace(/'/g,"\'")}',null,0,'un')">
      <span class="ac-custom">‚úè Usar "${inp.value}" como ingrediente libre</span>
    </div>`);
  }

  if(items.length){
    list.innerHTML=items.join('');
    list.classList.add('show');
  } else {
    list.classList.remove('show');
  }
};

window.acSel=function(id,name,pid,ppm,unit){
  const inp=document.getElementById('rn-'+id);
  const list=document.getElementById('ac-'+id);
  if(inp) inp.value=name;
  list.classList.remove('show');
  const ing=rIngs.find(i=>i.id===id);
  if(ing){ing.pid=pid;ing.name=name;ing.ppm=ppm||0;ing.unit=unit||'un';}
  // Set unit selector to product's unit if from catalog
  if(pid&&unit){
    const ru=document.getElementById('ru-'+id);
    if(ru){
      // Try to select matching unit
      for(let opt of ru.options){if(opt.value===unit){ru.value=unit;break;}}
    }
  }
  // Focus qty
  setTimeout(()=>document.getElementById('rq-'+id)?.focus(),50);
};

window.acHide=function(id){
  setTimeout(()=>{
    const list=document.getElementById('ac-'+id);
    if(list) list.classList.remove('show');
    // Save name from input if not set via acSel
    const inp=document.getElementById('rn-'+id);
    const ing=rIngs.find(i=>i.id===id);
    if(ing&&inp&&inp.value.trim()&&!ing.name){
      ing.name=inp.value.trim();
    }
  },150);
};

window.acKey=function(e,id){
  const list=document.getElementById('ac-'+id);
  const items=list?.querySelectorAll('.ing-ac-item');
  if(!items?.length) return;
  if(e.key==='ArrowDown'){e.preventDefault();acActive=Math.min(acActive+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();acActive=Math.max(acActive-1,0);}
  else if(e.key==='Enter'&&acActive>=0){e.preventDefault();items[acActive]?.dispatchEvent(new MouseEvent('mousedown'));}
  else if(e.key==='Escape'){list.classList.remove('show');return;}
  items.forEach((item,i)=>{item.style.background=i===acActive?'var(--abg)':'';});
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COLOR DE FICHA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.acJumpNext=function(id){
  // Find current row index and jump to next row's name input
  const rows=[...document.querySelectorAll('#rIC .ingrow')];
  const cur=rows.findIndex(r=>r.id==='ri-'+id);
  if(cur>=0&&cur<rows.length-1){
    const nextId=rows[cur+1].id.replace('ri-','');
    document.getElementById('rn-'+nextId)?.focus();
  } else {
    // Last row ‚Äî add a new one
    addRI();
  }
};

window.selCol=function(col,el){
  rColor=col;
  document.querySelectorAll('.rcol-btn').forEach(b=>{
    b.style.border=b.dataset.col===col?'3px solid var(--text)':'2px solid transparent';
  });
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVENTORY ENTER ‚Üí NEXT ROW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.invFocus=function(el){
  // Select all on focus so typing replaces value
  setTimeout(()=>{el.select();},10);
};

window.invKey=function(e,el){
  const isEnter=e.key==='Enter'||e.keyCode===13;
  const isTab=e.key==='Tab'||e.keyCode===9;
  if(!isEnter&&!isTab) return;
  e.preventDefault();
  e.stopPropagation();
  if(e.type==='keydown'&&!isTab) return;
  invJumpNext(el);
};

// Xiaomi ‚Üí| button sends Tab via touchend on some versions
window.invTouchEnd=function(e,el){
  // After touch, wait briefly ‚Äî if focus moved sideways, correct it
  setTimeout(()=>{
    const focused=document.activeElement;
    if(!focused||focused===el||!focused.classList.contains('ni2')) return;
    // Check if focus went to same row (sideways) instead of next row
    const curRow=el.closest('tr');
    const newRow=focused.closest('tr');
    if(curRow&&newRow&&curRow===newRow){
      // Wrong! jumped sideways ‚Äî correct to next row
      invJumpNext(el);
    }
  },50);
};

window.invJumpNext=function(el){
  const colIdx=el.closest('td')?.cellIndex??-1;
  const allRows=[...document.querySelectorAll('#invTb tr')];
  const curRow=el.closest('tr');
  const curRowIdx=allRows.indexOf(curRow);

  // Find same-column input in next rows
  for(let i=curRowIdx+1;i<allRows.length;i++){
    const cells=allRows[i].cells;
    if(colIdx>=0&&colIdx<cells.length){
      const inp=cells[colIdx].querySelector('input.ni2');
      if(inp){
        inp.focus();
        setTimeout(()=>{inp.select();},10);
        inp.scrollIntoView({behavior:'smooth',block:'center'});
        return;
      }
    }
  }
  // fallback: blur keyboard
  el.blur();
};

</script>
</body>
</html>
